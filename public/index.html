<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans Hebdomadaires</title>
    <!-- Dépendances CSS et JS (inchangées) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body dir="ltr">

    <!-- ======================== -->
    <!-- FORMULAIRE DE CONNEXION  -->
    <!-- ======================== -->
    <div id="login-form">
        <img id="logo" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo Al-Kawthar">
        <h1 id="login-title">Connexion</h1>
        
        <div class="section-selector-container" style="width:100%; margin-bottom:15px;">
            <label for="sectionSelectorLogin" id="label-section"><i class="fas fa-school"></i> Section :</label>
            <select id="sectionSelectorLogin" style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:5px;">
                <option id="option-garcons" value="garcons">Garçons</option>
                <option id="option-filles" value="filles">Filles</option>
            </select>
        </div>

        <div>
            <label for="username" id="label-username">Nom d'utilisateur (Enseignant) :</label>
            <input type="text" id="username" required>
        </div>
        <div class="password-container">
            <label for="password" id="label-password">Mot de passe (idem Nom) :</label>
            <input type="password" id="password" required>
            <i class="fas fa-eye password-toggle-icon" id="togglePassword"></i>
        </div>
        <div class="remember-me-container">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe" id="remember-me-label">Rester connecté</label>
        </div>
        <button id="login-button" class="pro-button"><i class="fas fa-sign-in-alt"></i> <span class="btn-text" id="login-btn-text">Se connecter</span></button>
        <p id="login-error"></p>
    </div>

    <!-- ======================== -->
    <!-- CONTENU PRINCIPAL        -->
    <!-- ======================== -->
    <div id="main-content" style="display: none;">

        <div class="main-header-container">
            <img id="logo-main" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo">
            <div class="title-user-info">
                <h1 id="main-title">Plans Hebdomadaires</h1>
                <h2 id="weekDateRange"></h2>
                <div class="user-actions-container">
                    <span id="loggedInUserInfo" style="font-style:italic;"></span>
                    <button id="logout-button" class="pro-button danger-button">
                        <i class="fas fa-sign-out-alt"></i> <span class="btn-text" id="logout-btn-text">Déconnecter</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="filter-container week-selector-container">
            <label for="weekSelector" id="label-week"><i class="fas fa-calendar-week"></i> Semaine:</label>
            <select id="weekSelector" onchange="loadPlanForWeek()"></select>
        </div>

        <div id="message-alerte" style="display: none;"></div>
        <div id="progress-bar-container" style="display: none;"><div id="progress-bar">0%</div></div>

        <!-- Boucle sur les sections pour générer le HTML -->
        <div id="section-container-wrapper">
            <!-- Le JS insérera le bon template de section ici -->
        </div>

    </div>

    <!-- TEMPLATES HTML POUR LES SECTIONS (cachés) -->
    <template id="section-template">
        <div class="section-container">
            <h2 class="section-title"></h2>
            
            <div class="filter-container main-actions-container">
                <button id="generateWordBtn" class="action-button pro-button" disabled><i class="fas fa-file-word"></i> <span class="btn-text" data-translate="generate_word_button">Générer Word par Classe</span></button>
                <button id="generateExcelBtn" class="action-button pro-button" disabled><i class="fas fa-file-excel"></i> <span class="btn-text" data-translate="generate_excel_button">Générer Excel (1 Fichier)</span></button>
                <button id="saveAllDisplayedBtn" class="action-button pro-button" disabled><i class="fas fa-save"></i> <span class="btn-text" data-translate="save_all_button">Enregistrer Lignes Affichées</span></button>
            </div>

            <div class="filter-container data-filters-container">
                <div class="filter-item" id="teacher-filter-container">
                    <label data-translate="filter_teacher_label"><i class="fas fa-user-tie"></i> Enseignant:</label> 
                    <select id="filterEnseignant"> <option value="">Tous</option> </select>
                </div>
                <div class="filter-item">
                    <label data-translate="filter_class_label"><i class="fas fa-chalkboard-user"></i> Classe:</label> 
                    <select id="filterClasse"> <option value="">Toutes</option> </select>
                </div>
                <div class="filter-item">
                    <label data-translate="filter_material_label"><i class="fas fa-book"></i> Matière:</label> 
                    <select id="filterMatiere"> <option value="">Toutes</option> </select>
                </div>
                <div class="filter-item">
                    <label data-translate="filter_period_label"><i class="fas fa-clock"></i> Période:</label> 
                    <select id="filterPeriode"> <option value="">Toutes</option> </select>
                </div>
                <div class="filter-item">
                    <label data-translate="filter_day_label"><i class="fas fa-calendar-day"></i> Jour:</label> 
                    <select id="filterJour">
                        <option value="" data-translate="all">Tous</option>
                        <option value="Dimanche" data-translate="day_sun">Dimanche</option>
                        <option value="Lundi" data-translate="day_mon">Lundi</option>
                        <option value="Mardi" data-translate="day_tue">Mardi</option>
                        <option value="Mercredi" data-translate="day_wed">Mercredi</option>
                        <option value="Jeudi" data-translate="day_thu">Jeudi</option>
                    </select>
                </div>
            </div>

             <div class="notes-container">
                <label data-translate="notes_for_class"><i class="fas fa-sticky-note"></i> Notes pour la classe :</label> 
                <select id="notesClassSelector"><option value="" data-translate="select_class">-- Sélectionnez une classe --</option></select>
                <textarea id="notesInput" rows="4" placeholder="Sélectionnez une classe..." spellcheck="true" disabled></textarea>
                <button id="saveNotesBtn" class="action-button pro-button success-button" disabled><i class="fas fa-save"></i> <span class="btn-text" data-translate="save_notes_button">Enregistrer Notes</span></button>
            </div>

            <div class="table-responsive-wrapper">
                <table id="planTable"><thead><tr></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </template>


    <script>
    // ====== GLOBALS ======
    let loggedInUser = null;
    let selectedSection = null; // 'garcons' ou 'filles'
    let isAdmin = false;
    let currentWeek = null;
    let currentUserLanguage = 'fr'; // fr, en, ar

    // Données séparées par section
    const sectionData = {
        garcons: { planData: [], filteredData: [], headers: [], weeklyClassNotes: {} },
        filles:  { planData: [], filteredData: [], headers: [], weeklyClassNotes: {} }
    };
    
    // ====== NOUVEAU : GESTION DES LANGUES ======
    const admins = new Set(['Mohamed', 'Zohra']);
    const arabicUsers = new Set(['Jaber', 'Majed', 'Saeed', 'Fatima', 'Amal Najar', 'Emen', 'Ghadah', 'Raghd', 'Sara']);
    const englishUsers = new Set(['Amal', 'Kamel', 'Abeer', 'Salma']);

    const teachers_garcons = new Set(['Abas','Jaber','Kamel','Majed','Mohamed Ali','Morched','Saeed','Sami','Sylvano','Tonga','Youssef','Zine', ...admins]);
    const teachers_filles = new Set(['Abeer','Aichetou','Amal','Amal Arabic','Amal Najar','Ange','Anouar','Emen','Farah','Fatima','Ghadah','Hana - Ameni - PE','Nada','Raghd','Salma','Sara','Souha','Takwa','Zohra Zidane', ...admins]);
    
    const translations = {
        fr: {
            // Login
            login_title: "Connexion", section: "Section :", boys: "Garçons", girls: "Filles", username_label: "Nom d'utilisateur :", password_label: "Mot de passe :", remember_me: "Rester connecté", login_button: "Se connecter",
            // Main UI
            logout_button: "Déconnecter", main_page_title: "Plans Hebdomadaires", connected_as: "Connecté : {user}", week: "Semaine :", select_week: "-- Sélectionnez une semaine --",
            // Section Titles
            section_title_garcons: "Section Garçons", section_title_filles: "Section Filles",
            // Buttons
            generate_word_button: "Générer Word par Classe", generate_excel_button: "Générer Excel (1 Fichier)", save_all_button: "Enregistrer Lignes Affichées",
            // Filters
            filter_teacher_label: "Enseignant:", filter_class_label: "Classe:", filter_material_label: "Matière:", filter_period_label: "Période:", filter_day_label: "Jour:", all: "Tous", all_f: "Toutes",
            // Days
            day_sun: "Dimanche", day_mon: "Lundi", day_tue: "Mardi", day_wed: "Mercredi", day_thu: "Jeudi",
            // Notes
            notes_for_class: "Notes pour la classe :", select_class: "-- Sélectionnez une classe --", save_notes_button: "Enregistrer Notes", notes_placeholder: "Sélectionnez une classe pour ajouter des notes...",
            // Table
            actions: "Actions", updated_at: "Mis à jour", no_data_to_display: "Aucune donnée à afficher.",
        },
        en: {
            login_title: "Login", section: "Section:", boys: "Boys", girls: "Girls", username_label: "Username:", password_label: "Password:", remember_me: "Remember me", login_button: "Login",
            logout_button: "Logout", main_page_title: "Weekly Plans", connected_as: "Connected: {user}", week: "Week:", select_week: "-- Select a week --",
            section_title_garcons: "Boys Section", section_title_filles: "Girls Section",
            generate_word_button: "Generate Word by Class", generate_excel_button: "Generate Excel (1 File)", save_all_button: "Save Displayed Rows",
            filter_teacher_label: "Teacher:", filter_class_label: "Class:", filter_material_label: "Subject:", filter_period_label: "Period:", filter_day_label: "Day:", all: "All", all_f: "All",
            day_sun: "Sunday", day_mon: "Monday", day_tue: "Tuesday", day_wed: "Wednesday", day_thu: "Thursday",
            notes_for_class: "Notes for class:", select_class: "-- Select a class --", save_notes_button: "Save Notes", notes_placeholder: "Select a class to add notes...",
            actions: "Actions", updated_at: "Updated At", no_data_to_display: "No data to display.",
        },
        ar: {
            login_title: "تسجيل الدخول", section: "قسم:", boys: "بنين", girls: "بنات", username_label: "اسم المستخدم:", password_label: "كلمة المرور:", remember_me: "تذكرني", login_button: "تسجيل الدخول",
            logout_button: "تسجيل الخروج", main_page_title: "الخطط الأسبوعية", connected_as: "متصل: {user}", week: "الأسبوع:", select_week: "-- اختر أسبوع --",
            section_title_garcons: "قسم البنين", section_title_filles: "قسم البنات",
            generate_word_button: "إنشاء ملف وورد", generate_excel_button: "إنشاء ملف اكسل", save_all_button: "حفظ الصفوف المعروضة",
            filter_teacher_label: "المعلم:", filter_class_label: "الفصل:", filter_material_label: "المادة:", filter_period_label: "الحصة:", filter_day_label: "اليوم:", all: "الكل", all_f: "الكل",
            day_sun: "الأحد", day_mon: "الاثنين", day_tue: "الثلاثاء", day_wed: "الأربعاء", day_thu: "الخميس",
            notes_for_class: "ملاحظات للفصل:", select_class: "-- اختر فصل --", save_notes_button: "حفظ الملاحظات", notes_placeholder: "اختر فصلاً لإضافة ملاحظات...",
            actions: "الإجراءات", updated_at: "آخر تحديث", no_data_to_display: "لا توجد بيانات لعرضها.",
        }
    };

    const t = (key, params = {}) => {
        let text = translations[currentUserLanguage]?.[key] || translations.fr[key] || key;
        for (const p in params) { text = text.replace(`{${p}}`, params[p]); }
        return text;
    };
    
    function applyLanguageSettings() {
        document.documentElement.lang = currentUserLanguage;
        document.body.dir = (currentUserLanguage === 'ar') ? 'rtl' : 'ltr';

        // Login Page
        document.getElementById('login-title').textContent = t('login_title');
        document.getElementById('label-section').innerHTML = `<i class="fas fa-school"></i> ${t('section')}`;
        document.getElementById('option-garcons').textContent = t('boys');
        document.getElementById('option-filles').textContent = t('girls');
        document.getElementById('label-username').textContent = t('username_label');
        document.getElementById('label-password').textContent = t('password_label');
        document.getElementById('remember-me-label').textContent = t('remember_me');
        document.getElementById('login-btn-text').textContent = t('login_button');

        // Main Page
        if (loggedInUser) {
            document.getElementById('main-title').textContent = t('main_page_title');
            document.getElementById('logout-btn-text').textContent = t('logout_button');
            document.getElementById('loggedInUserInfo').textContent = t('connected_as', {user: loggedInUser});
            document.getElementById('label-week').innerHTML = `<i class="fas fa-calendar-week"></i> ${t('week')}`;
            
            const weekSelector = document.getElementById('weekSelector');
            if (weekSelector.options.length > 0 && weekSelector.options[0].value === "") {
                weekSelector.options[0].textContent = t('select_week');
            }

            // Translate the visible section
            const sectionContainer = document.querySelector('#section-container-wrapper .section-container');
            if (sectionContainer) {
                 sectionContainer.querySelector('.section-title').textContent = t(`section_title_${selectedSection}`);
                 sectionContainer.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    if (el.tagName === 'OPTION') el.textContent = t(key);
                    else if (el.classList.contains('btn-text') || el.tagName === 'LABEL') {
                        // For labels with icons, preserve the icon
                        const icon = el.querySelector('i');
                        if (icon) {
                           el.innerHTML = `${icon.outerHTML} ${t(key)}`;
                        } else {
                           el.textContent = t(key);
                        }
                    } else {
                        el.textContent = t(key);
                    }
                });
                renderTable(); // Re-render table to update headers
            }
        }
    }

    const weekDates = { /* ... collez ici l'objet weekDates de votre code actuel ... */ };
    const classOrder = ['PEI1','PEI2','PEI3','PEI4','PEI5','DP1','DP2'];
    function compareClasses(a, b) { const ia=classOrder.indexOf(a), ib=classOrder.indexOf(b); if(ia!==-1&&ib!==-1) return ia-ib; return String(a||'').localeCompare(String(b||'')); }

    // ====== UTILS ======
    function setBtnLoading(btn, loading, iconClass) { if(!btn) return; btn.disabled = loading; const i = btn.querySelector('i'); if(i) i.className = loading ? 'fas fa-spinner fa-spin' : iconClass; }
    function alertMsg(msg, type='success') { const div=document.getElementById('message-alerte'); div.className=`message-alert-base alert-${type}`; div.textContent=msg; div.style.display='block'; setTimeout(() => { div.style.display='none'; }, type==='error' ? 8000 : 5000); }
    function formatUpdatedAt(s) { if(!s) return ''; const d=new Date(s); if(isNaN(d.getTime())) return''; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    const findH = (k) => sectionData[selectedSection]?.headers.find(h => h.trim().toLowerCase() === String(k).toLowerCase());

    // ====== LOGIN / LOGOUT ======
    async function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const section = document.getElementById('sectionSelectorLogin').value;
        const errDiv = document.getElementById('login-error');
        errDiv.textContent = '';

        if (!username || !password) { errDiv.textContent = "Entrez nom d'utilisateur et mot de passe."; return; }

        setBtnLoading(document.getElementById('login-button'), true, 'fas fa-sign-in-alt');
        try {
            const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.message || 'Échec connexion.');

            loggedInUser = result.username;
            selectedSection = section;
            isAdmin = admins.has(loggedInUser);
            
            if (!isAdmin) {
                const authorizedTeachers = selectedSection === 'garcons' ? teachers_garcons : teachers_filles;
                if (!authorizedTeachers.has(loggedInUser)) throw new Error('Utilisateur non autorisé pour cette section.');
            }

            // MODIFIÉ : Définir la langue de l'utilisateur
            if (arabicUsers.has(loggedInUser)) currentUserLanguage = 'ar';
            else if (englishUsers.has(loggedInUser)) currentUserLanguage = 'en';
            else currentUserLanguage = 'fr';

            document.getElementById('login-form').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            createSectionUI(selectedSection); // Crée l'UI pour la section choisie

            const weekSelector = document.getElementById('weekSelector');
            weekSelector.innerHTML = `<option value="">${t('select_week')}</option>`;
            for (let i = 1; i <= 48; i++) {
                const option = document.createElement('option'); option.value = i; option.textContent = `${t('week')} ${i}`; weekSelector.appendChild(option);
            }
            
            applyLanguageSettings(); // Appliquer les traductions
            alertMsg(`Bienvenue ${loggedInUser}!`, 'success');

        } catch (e) {
            errDiv.textContent = e.message;
        } finally {
            setBtnLoading(document.getElementById('login-button'), false, 'fas fa-sign-in-alt');
        }
    }

    function handleLogout() {
        loggedInUser = null; selectedSection = null; isAdmin = false; currentWeek = null;
        currentUserLanguage = 'fr'; // Reset to default
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('section-container-wrapper').innerHTML = ''; // Vider le conteneur
        applyLanguageSettings();
    }
    
    // ====== UI CREATION ======
    function createSectionUI(section) {
        const container = document.getElementById('section-container-wrapper');
        const template = document.getElementById('section-template');
        const clone = template.content.firstElementChild.cloneNode(true);
        
        // Uniquify IDs
        clone.querySelectorAll('[id]').forEach(el => {
            el.id = `${el.id}_${section}`;
        });

        container.innerHTML = '';
        container.appendChild(clone);
        
        // MODIFIÉ : Cacher le filtre enseignant pour les non-admins
        if (!isAdmin) {
            const teacherFilter = clone.querySelector(`#teacher-filter-container_${section}`);
            if (teacherFilter) teacherFilter.style.display = 'none';
        }

        // Attacher les événements aux nouveaux éléments
        attachSectionEventListeners(section);
    }
    
    // ====== DATA & RENDERING ======
    async function loadPlanForWeek() {
        const week = document.getElementById('weekSelector').value;
        currentWeek = week;
        if (!week) { /* ... reset logic ... */ return; }

        try {
            const response = await fetch(`/api/plans/${week}?section=${selectedSection}`);
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erreur serveur.');

            const data = sectionData[selectedSection];
            data.planData = Array.isArray(result.planData) ? result.planData : [];
            data.weeklyClassNotes = result.classNotes || {};
            data.headers = data.planData.length ? Object.keys(data.planData[0]).filter(k => k !== '_id' && k !== 'id') : [];
            
            sortAndDisplay(); 
            populateFilterOptions();
            populateNotesClassSelector();
            updateActionButtonsState(true);

        } catch (e) {
            alertMsg(`Erreur chargement S${week}: ${e.message}`, 'error');
        }
    }

    function sortAndDisplay() {
        const section = selectedSection;
        const data = sectionData[section].planData;
        
        const ensF = isAdmin ? document.getElementById(`filterEnseignant_${section}`).value : '';
        const clsF = document.getElementById(`filterClasse_${section}`).value;
        const matF = document.getElementById(`filterMatiere_${section}`).value;
        const perF = document.getElementById(`filterPeriode_${section}`).value;
        const jF = document.getElementById(`filterJour_${section}`).value;

        const ensK = findH('Enseignant'), clsK = findH('Classe'), matK = findH('Matière'), perK = findH('Période'), jK = findH('Jour');

        let filtered = data.filter(item => {
            // MODIFIÉ : Logique de filtrage enseignant
            const passEns = isAdmin ? (!ensF || (ensK && item[ensK] === ensF)) : (ensK && item[ensK] === loggedInUser);
            
            const passCls = !clsF || (clsK && item[clsK] === clsF);
            const passMat = !matF || (matK && item[matK] === matF);
            const passPer = !perF || (perK && String(item[perK]) === perF);
            const passJour = !jF || (jK && item[jK] === jF);
            return passEns && passCls && passMat && passPer && passJour;
        });

        const dayOrder = { "Dimanche": 1, "Lundi": 2, "Mardi": 3, "Mercredi": 4, "Jeudi": 5 };
        filtered.sort((a, b) => {
            const classComp = compareClasses(a[clsK], b[clsK]);
            if (classComp !== 0) return classComp;
            const dayComp = (dayOrder[a[jK]] || 99) - (dayOrder[b[jK]] || 99);
            if (dayComp !== 0) return dayComp;
            return (parseInt(a[perK], 10) || 0) - (parseInt(b[perK], 10) || 0);
        });

        sectionData[section].filteredData = filtered;
        renderTable();
    }
    
    function renderTable() {
        const section = selectedSection;
        const thead = document.querySelector(`#planTable_${section} thead tr`);
        const tbody = document.querySelector(`#planTable_${section} tbody`);
        thead.innerHTML = ''; tbody.innerHTML = '';
        
        const data = sectionData[section].filteredData;
        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;">${t('no_data_to_display')}</td></tr>`;
            return;
        }

        const baseHeaders = ['Jour', 'Période', 'Classe', 'Matière', 'Leçon', 'Travaux de classe', 'Support', 'Devoirs'];
        const headersToDisplay = isAdmin ? ['Enseignant', ...baseHeaders] : baseHeaders;
        
        headersToDisplay.forEach(hKey => { const th = document.createElement('th'); th.textContent = t(`headers.${hKey.toLowerCase().replace(/ /g,'_')}`, {}, hKey); thead.appendChild(th); });
        
        const thActions = document.createElement('th'); thActions.textContent = t('actions'); thead.appendChild(thActions);
        const thUpdated = document.createElement('th'); thUpdated.textContent = t('updated_at'); thead.appendChild(thUpdated);
        
        const editableKeys = new Set(['Leçon', 'Travaux de classe', 'Support', 'Devoirs']);

        data.forEach((rowData, rowIndex) => {
            const tr = document.createElement('tr');
            tr.dataset.rowIndex = rowIndex;
            
            headersToDisplay.forEach(header => {
                const key = findH(header);
                const td = document.createElement('td');
                td.textContent = key ? (rowData[key] ?? '') : '';
                td.dir = 'auto'; // Support RTL/LTR content
                if (editableKeys.has(header)) {
                    td.contentEditable = true;
                    td.classList.add('editable');
                    td.addEventListener('input', (e) => {
                        if (key) rowData[key] = e.target.textContent;
                        tr.classList.add('modified');
                    });
                }
                tr.appendChild(td);
            });
            
            const tdActions = document.createElement('td');
            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '<i class="fas fa-check"></i>'; saveBtn.className = 'save-row-button';
            saveBtn.onclick = () => saveRow(rowData, tr);
            tdActions.appendChild(saveBtn);
            tr.appendChild(tdActions);

            const tdUpdated = document.createElement('td');
            const updKey = findH('updatedAt');
            tdUpdated.textContent = updKey ? formatUpdatedAt(rowData[updKey]) : '';
            tr.appendChild(tdUpdated);

            tbody.appendChild(tr);
        });
    }

    // ====== ACTIONS ======
    async function saveRow(rowData, tr) {
        const section = selectedSection;
        const btn = tr.querySelector('.save-row-button');
        setBtnLoading(btn, true, 'fas fa-check');
        try {
            const response = await fetch('/api/save-row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ week: currentWeek, data: rowData, section: section })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erreur.');
            
            tr.classList.remove('modified');
            const updKey = findH('updatedAt');
            if (updKey && result.updatedData?.updatedAt) {
                rowData[updKey] = result.updatedData.updatedAt;
                // Last cell is 'updatedAt'
                tr.cells[tr.cells.length - 1].textContent = formatUpdatedAt(result.updatedData.updatedAt);
            }
            alertMsg('Ligne enregistrée.', 'success');
        } catch (e) {
            alertMsg(e.message, 'error');
        } finally {
            setBtnLoading(btn, false, 'fas fa-check');
        }
    }
    
    async function generateWordByClasse() {
        const section = selectedSection;
        const dataToExport = sectionData[section].filteredData;
        if (!dataToExport.length) { alertMsg('Aucune donnée.', 'error'); return; }

        setBtnLoading(document.getElementById(`generateWordBtn_${section}`), true, 'fas fa-file-word');
        const byClass = {};
        const classKey = findH('Classe');
        dataToExport.forEach(r => { const c = r[classKey]; if(c) (byClass[c] ||= []).push(r); });
        
        let ok = 0, err = 0;
        for (const classe of Object.keys(byClass)) {
            try {
                const response = await fetch('/api/generate-word', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ week: currentWeek, classe, data: byClass[classe], notes: sectionData[section].weeklyClassNotes[classe] || '', section })
                });
                if (!response.ok) throw new Error(`Erreur ${classe}`);
                const blob = await response.blob();
                saveAs(blob, `Plan_${section}_S${currentWeek}_${classe}.docx`);
                ok++;
            } catch { err++; }
        }
        alertMsg(err ? `Word: ${ok} succès / ${err} erreurs.` : 'Documents Word générés.', 'success');
        setBtnLoading(document.getElementById(`generateWordBtn_${section}`), false, 'fas fa-file-word');
    }

    // ====== HELPERS & EVENT LISTENERS ======
    function populateFilterOptions() {
        const section = selectedSection;
        const data = sectionData[section].planData;
        const getUniq = (k) => [...new Set(data.map(i => i[k]).filter(Boolean))].sort();

        const updateSel = (id, opts, isClass = false) => {
            const sel = document.getElementById(id);
            sel.innerHTML = `<option value="">${t(isClass ? 'all_f' : 'all')}</option>`;
            opts.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; sel.appendChild(opt); });
        };
        
        if (isAdmin) {
            updateSel(`filterEnseignant_${section}`, getUniq(findH('Enseignant')));
        }
        updateSel(`filterClasse_${section}`, getUniq(findH('Classe')).sort(compareClasses), true);
        updateSel(`filterMatiere_${section}`, getUniq(findH('Matière')));
        updateSel(`filterPeriode_${section}`, getUniq(findH('Période')));
    }

    function populateNotesClassSelector() {
        const section = selectedSection;
        const sel = document.getElementById(`notesClassSelector_${section}`);
        sel.innerHTML = `<option value="">${t('select_class')}</option>`;
        const classes = [...new Set(sectionData[section].planData.map(r => r[findH('Classe')]).filter(Boolean))].sort(compareClasses);
        classes.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
        document.getElementById(`notesInput_${section}`).disabled = true;
        document.getElementById(`saveNotesBtn_${section}`).disabled = true;
    }
    
    function displayClassNotes() {
        const section = selectedSection;
        const c = document.getElementById(`notesClassSelector_${section}`).value;
        const txt = document.getElementById(`notesInput_${section}`);
        const btn = document.getElementById(`saveNotesBtn_${section}`);
        if (!c) { txt.value = ''; txt.disabled = true; btn.disabled = true; return; }
        txt.value = sectionData[section].weeklyClassNotes[c] || '';
        txt.disabled = false;
        btn.disabled = false;
    }

    async function saveNotes() {
        const section = selectedSection;
        const c = document.getElementById(`notesClassSelector_${section}`).value;
        if (!c || !currentWeek) return;
        const btn = document.getElementById(`saveNotesBtn_${section}`);
        setBtnLoading(btn, true, 'fas fa-save');
        try {
            const r = await fetch('/api/save-notes', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ week: currentWeek, classe: c, notes: document.getElementById(`notesInput_${section}`).value, section })
            });
            const j = await r.json();
            if (!r.ok) throw new Error(j.message || 'Erreur.');
            sectionData[section].weeklyClassNotes[c] = document.getElementById(`notesInput_${section}`).value;
            alertMsg(`Notes pour ${c} enregistrées.`, 'success');
        } catch (e) {
            alertMsg(e.message, 'error');
        } finally {
            setBtnLoading(btn, false, 'fas fa-save');
        }
    }

    function updateActionButtonsState(enabled) {
        if (!selectedSection) return;
        const section = selectedSection;
        document.getElementById(`generateWordBtn_${section}`).disabled = !enabled;
        document.getElementById(`generateExcelBtn_${section}`).disabled = true; // Not implemented in this version
        document.getElementById(`saveAllDisplayedBtn_${section}`).disabled = !enabled;
    }

    function attachSectionEventListeners(section) {
        document.getElementById(`generateWordBtn_${section}`).addEventListener('click', generateWordByClasse);
        
        document.getElementById(`filterEnseignant_${section}`)?.addEventListener('change', sortAndDisplay);
        document.getElementById(`filterClasse_${section}`).addEventListener('change', sortAndDisplay);
        document.getElementById(`filterMatiere_${section}`).addEventListener('change', sortAndDisplay);
        document.getElementById(`filterPeriode_${section}`).addEventListener('change', sortAndDisplay);
        document.getElementById(`filterJour_${section}`).addEventListener('change', sortAndDisplay);
        
        document.getElementById(`notesClassSelector_${section}`).addEventListener('change', displayClassNotes);
        document.getElementById(`saveNotesBtn_${section}`).addEventListener('click', saveNotes);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('togglePassword').addEventListener('click', () => {
             const p = document.getElementById('password'); 
             p.type = p.type === 'password' ? 'text' : 'password';
        });
        applyLanguageSettings(); // Translate login page on load
    });
    </script>
</body>
</html>
