<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plans Hebdomadaires</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-form">
    <img id="logo" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo">
    <h1>Connexion</h1>

    <div class="section-selector-container">
      <label for="sectionSelectorLogin"><i class="fas fa-school"></i> Section :</label>
      <select id="sectionSelectorLogin">
        <option value="garcons">Garçons</option>
        <option value="filles">Filles</option>
      </select>
    </div>

    <div>
      <label for="username">Nom d'utilisateur (Enseignant) :</label>
      <input id="username" type="text" />
    </div>

    <div class="password-container">
      <label for="password">Mot de passe (idem Nom) :</label>
      <input id="password" type="password" />
      <i class="fas fa-eye password-toggle-icon" id="togglePassword"></i>
    </div>

    <div class="remember-me-container">
      <input id="rememberMe" type="checkbox" />
      <label for="rememberMe">Rester connecté</label>
    </div>

    <button id="login-button" class="pro-button"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
    <p id="login-error"></p>
  </div>

  <!-- MAIN -->
  <div id="main-content" style="display:none;">
    <div class="main-header-container">
      <img id="logo-main" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo">
      <div class="title-user-info">
        <h1 id="main-title">Plans Hebdomadaires</h1>
        <h2 id="weekDateRange"></h2>
        <div class="user-actions-container">
          <span id="loggedInUserInfo" style="font-style:italic;"></span>
          <button id="logout-button" class="pro-button danger-button"><i class="fas fa-sign-out-alt"></i> Déconnecter</button>
        </div>
      </div>
    </div>

    <div class="filter-container week-selector-container">
      <label for="weekSelector"><i class="fas fa-calendar-week"></i> Semaine :</label>
      <select id="weekSelector"></select>
    </div>

    <div id="admin-actions" class="filter-container admin-section" style="display:none;">
      <h3>Actions Administrateur</h3>
      <div>
        <label for="excelFileInput"><i class="fas fa-file-excel"></i> Fichier Excel :</label>
        <input id="excelFileInput" type="file" accept=".xlsx,.xls" />
      </div>
      <button id="saveUploadedDataBtn" class="pro-button accent-button" disabled>
        <i class="fas fa-database"></i> Charger et Enregistrer dans la DB
      </button>
      <span id="file-upload-status" style="font-size:.9em;"></span>

      <div class="admin-subsection">
        <label for="adminReportClassSelector"><i class="fas fa-school"></i> Choisir une Classe :</label>
        <select id="adminReportClassSelector"><option value="">-- D'abord charger les classes --</option></select>
        <button id="generateFullReportBtn" class="pro-button success-button">
          <i class="fas fa-file-invoice"></i> Générer Rapport Complet par Classe
        </button>
      </div>
    </div>

    <div class="filter-container main-actions-container">
      <button id="generateWordBtn" class="pro-button" disabled><i class="fas fa-file-word"></i> Générer Word par Classe</button>
      <button id="generateExcelBtn" class="pro-button" disabled><i class="fas fa-file-excel"></i> Générer Excel (1 Fichier)</button>
      <button id="saveAllDisplayedBtn" class="pro-button" disabled><i class="fas fa-save"></i> Enregistrer Lignes Affichées</button>
    </div>

    <div id="message-alerte" style="display:none;"></div>
    <div id="progress-bar-container" style="display:none;"><div id="progress-bar">0%</div></div>

    <div class="notes-container">
      <label for="notesClassSelector" style="font-weight:bold;"><i class="fas fa-sticky-note"></i> Notes pour la classe :</label>
      <select id="notesClassSelector"><option value="">-- Sélectionnez une classe --</option></select>
      <textarea id="notesInput" rows="4" placeholder="Sélectionnez une classe..." disabled></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:5px;">
        <button id="saveNotesBtn" class="pro-button success-button" disabled><i class="fas fa-save"></i> Enregistrer Notes</button>
        <span id="notes-save-status" style="font-size:.9em;"></span>
      </div>
    </div>

    <div class="table-responsive-wrapper">
      <table id="planTable">
        <thead><tr></tr></thead>
        <tbody><tr id="initial-table-row"><td id="initial-table-message" colspan="10" style="text-align:center;padding:20px;color:#777">Veuillez sélectionner une semaine pour afficher les données.</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    // —————————— GLOBALS ——————————
    let loggedInUser = null;
    let selectedSection = null;
    let planData = [];
    let filteredData = [];
    let headers = [];
    let currentWeek = null;
    let weeklyClassNotes = {};
    let uploadedPlanData = null;

    const admins = new Set(['Mohamed','Zohra']);

    const weeks = Array.from({length:48}, (_,i)=>i+1);
    const specificWeekDateRanges = {
      1:{start:'2025-08-31',end:'2025-09-04'},2:{start:'2025-09-07',end:'2025-09-11'},3:{start:'2025-09-14',end:'2025-09-18'},
      4:{start:'2025-09-21',end:'2025-09-25'},5:{start:'2025-09-28',end:'2025-10-02'},6:{start:'2025-10-05',end:'2025-10-09'},
      7:{start:'2025-10-12',end:'2025-10-16'},8:{start:'2025-10-19',end:'2025-10-23'},9:{start:'2025-10-26',end:'2025-10-30'},
      10:{start:'2025-11-02',end:'2025-11-06'},11:{start:'2025-11-09',end:'2025-11-13'},12:{start:'2025-11-16',end:'2025-11-20'},
      13:{start:'2025-11-23',end:'2025-11-27'},14:{start:'2025-11-30',end:'2025-12-04'},15:{start:'2025-12-07',end:'2025-12-11'},
      16:{start:'2025-12-14',end:'2025-12-18'},17:{start:'2025-12-21',end:'2025-12-25'},18:{start:'2025-12-28',end:'2026-01-01'},
      19:{start:'2026-01-04',end:'2026-01-08'},20:{start:'2026-01-11',end:'2026-01-15'},21:{start:'2026-01-18',end:'2026-01-22'},
      22:{start:'2026-01-25',end:'2026-01-29'},23:{start:'2026-02-01',end:'2026-02-05'},24:{start:'2026-02-08',end:'2026-02-12'},
      25:{start:'2026-02-15',end:'2026-02-19'},26:{start:'2026-02-22',end:'2026-02-26'},27:{start:'2026-03-01',end:'2026-03-05'},
      28:{start:'2026-03-08',end:'2026-03-12'},29:{start:'2026-03-15',end:'2026-03-19'},30:{start:'2026-03-22',end:'2026-03-26'},
      31:{start:'2026-03-29',end:'2026-04-02'},32:{start:'2026-04-05',end:'2026-04-09'},33:{start:'2026-04-12',end:'2026-04-16'},
      34:{start:'2026-04-19',end:'2026-04-23'},35:{start:'2026-04-26',end:'2026-04-30'},36:{start:'2026-05-03',end:'2026-05-07'},
      37:{start:'2026-05-10',end:'2026-05-14'},38:{start:'2026-05-17',end:'2026-05-21'},39:{start:'2026-05-24',end:'2026-05-28'},
      40:{start:'2026-05-31',end:'2026-06-04'},41:{start:'2026-06-07',end:'2026-06-11'},42:{start:'2026-06-14',end:'2026-06-18'},
      43:{start:'2026-06-21',end:'2026-06-25'},44:{start:'2026-06-28',end:'2026-07-02'},45:{start:'2026-07-05',end:'2026-07-09'},
      46:{start:'2026-07-12',end:'2026-07-16'},47:{start:'2026-07-19',end:'2026-07-23'},48:{start:'2026-07-26',end:'2026-07-30'}
    };

    const classOrder = ['PEI1','PEI2','PEI3','PEI4','PEI5','DP1','DP2'];
    const findH = (target) => headers.find(h => h.trim().toLowerCase() === String(target).toLowerCase());

    // —————————— UI HELPERS ——————————
    function setBtnLoading(btn, loading, icon) {
      if (!btn) return;
      btn.disabled = loading;
      const i = btn.querySelector('i');
      if (i) i.className = loading ? 'fas fa-spinner fa-spin' : icon;
    }
    function alertMsg(text, type='success') {
      const div = document.getElementById('message-alerte');
      div.className = `message-alert-base alert-${type}`;
      div.textContent = text;
      div.style.display = 'block';
      setTimeout(()=>{ div.style.display='none'; }, type==='error'?8000:5000);
    }
    function compareClasses(a,b){
      const ia = classOrder.indexOf(a), ib = classOrder.indexOf(b);
      if (ia!==-1 && ib!==-1) return ia-ib;
      return String(a).localeCompare(String(b));
    }

    // —————————— LOGIN ——————————
    async function handleLogin(){
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const err = document.getElementById('login-error');
      const remember = document.getElementById('rememberMe').checked;
      selectedSection = document.getElementById('sectionSelectorLogin').value;

      err.textContent = '';
      if (!username || !password) { err.textContent = "Entrez nom d'utilisateur et mot de passe."; return; }
      setBtnLoading(document.getElementById('login-button'), true, 'fas fa-sign-in-alt');
      try {
        const r = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
        const okJson = await r.json();
        if (!r.ok || !okJson.success) throw new Error(okJson.message || 'Échec connexion.');

        // restriction section côté front (admins passent partout)
        if (!admins.has(username)) {
          const g = new Set(['Abas','Jaber','Kamel','Majed','Mohamed Ali','Morched','Saeed','Sami','Sylvano','Tonga','Youssef','Zine']);
          const f = new Set(['Abeer','Aichetou','Amal','Amal Arabic','Ange','Anouar','Emen','Farah','Fatima Islamic','Ghadah','Hana - Ameni - PE','Nada','Raghd ART','Salma','Sara','Souha','Takwa','Zohra Zidane']);
          if (selectedSection==='garcons' && !g.has(username)) throw new Error('Utilisateur non autorisé (Garçons).');
          if (selectedSection==='filles' && !f.has(username)) throw new Error('Utilisateur non autorisé (Filles).');
        }

        loggedInUser = okJson.username;
        if (remember) localStorage.setItem('rememberedUser', JSON.stringify({ user: loggedInUser, section: selectedSection }));
        else localStorage.removeItem('rememberedUser');

        document.getElementById('login-form').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('loggedInUserInfo').textContent = `Connecté: ${loggedInUser}`;
        document.getElementById('main-title').textContent = `Plans Hebdomadaires - ${selectedSection[0].toUpperCase()+selectedSection.slice(1)}`;

        // remplir liste semaines
        const weekSel = document.getElementById('weekSelector');
        weekSel.innerHTML = '<option value="">-- Sélectionnez une semaine --</option>';
        weeks.forEach(w => {
          const opt = document.createElement('option'); opt.value = w; opt.textContent = `Semaine ${w}`; weekSel.appendChild(opt);
        });

        // admin UI
        document.getElementById('admin-actions').style.display = admins.has(loggedInUser) ? 'flex' : 'none';

        alertMsg(`Bienvenue ${loggedInUser}!`, 'success');
      } catch (e) {
        err.textContent = e.message;
      } finally {
        setBtnLoading(document.getElementById('login-button'), false, 'fas fa-sign-in-alt');
      }
    }

    function handleLogout(){
      loggedInUser = null; selectedSection = null;
      localStorage.removeItem('rememberedUser');
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('username').value=''; document.getElementById('password').value='';
      document.getElementById('login-error').textContent='';
    }

    // —————————— DATA FLOW ——————————
    async function loadPlanForWeek() {
      const week = document.getElementById('weekSelector').value;
      if (!week) { resetMain(); return; }
      currentWeek = week;

      try {
        const r = await fetch(`/api/plans/${week}?section=${selectedSection}`);
        const ct = (r.headers.get('content-type') || '').toLowerCase();
        if (!ct.includes('application/json')) {
          const txt = await r.text();
          throw new Error(`Réponse non-JSON (status ${r.status}) : ${txt.slice(0,160)}`);
        }
        const data = await r.json();
        planData = Array.isArray(data.planData) ? data.planData : [];
        weeklyClassNotes = data.classNotes || {};

        // headers: nettoyer pour l’affichage
        headers = planData.length ? Object.keys(planData[0]).filter(h => h !== '_id' && h !== 'id') : [];
        if (!headers.length) headers = ['Enseignant','Jour','Période','Classe','Matière','Leçon','Travaux de classe','Support','Devoirs'];

        // dates semaine
        const info = specificWeekDateRanges[week];
        const f = d => {
          const x = new Date(d+'T00:00:00Z');
          const m = ['Janv','Fév','Mars','Avr','Mai','Juin','Juil','Août','Sept','Oct','Nov','Déc'];
          const j = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
          return `${j[x.getUTCDay()]} ${String(x.getUTCDate()).padStart(2,'0')} ${m[x.getUTCMonth()]} ${x.getUTCFullYear()}`;
        };
        document.getElementById('weekDateRange').textContent = info ? `Semaine ${week} : du ${f(info.start)} à ${f(info.end)}` : `Semaine ${week}`;

        filteredData = planData.slice();
        renderTable();
        populateNotesClassSelector();
        updateActionButtonsState(planData.length>0);
        populateAdminReportClassSelector();
      } catch (e) {
        alertMsg(`Erreur chargement S${week}: ${e.message}`, 'error');
        resetMain();
      }
    }

    function resetMain(){
      planData = []; filteredData = []; headers = []; weeklyClassNotes = {};
      document.querySelector('#planTable thead tr').innerHTML = '';
      document.querySelector('#planTable tbody').innerHTML =
        '<tr><td colspan="10" style="text-align:center;padding:20px;color:#777">Veuillez sélectionner une semaine pour afficher les données.</td></tr>';
      document.getElementById('generateWordBtn').disabled = true;
      document.getElementById('generateExcelBtn').disabled = true;
      document.getElementById('saveAllDisplayedBtn').disabled = true;
      document.getElementById('weekDateRange').textContent = '';
      document.getElementById('notesClassSelector').innerHTML = '<option value="">-- Sélectionnez une classe --</option>';
      document.getElementById('notesInput').value = ''; document.getElementById('notesInput').disabled = true;
      document.getElementById('saveNotesBtn').disabled = true;
      document.getElementById('excelFileInput').value = '';
      document.getElementById('saveUploadedDataBtn').disabled = true;
      document.getElementById('file-upload-status').textContent = '';
    }

    // Rendu du tableau minimal + édition Leçon/Travaux/Support/Devoirs
    function renderTable(){
      const thead = document.querySelector('#planTable thead tr');
      const tbody = document.querySelector('#planTable tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';

      const displayHeaders = [...new Set([
        'Enseignant','Jour','Période','Classe','Matière','Leçon','Travaux de classe','Support','Devoirs','updatedAt','__actions'
      ])].filter(h => h !== 'updatedAt' || planData.some(r => r.updatedAt));

      displayHeaders.forEach(h => {
        const th = document.createElement('th');
        th.textContent = (h === '__actions') ? 'Actions' : h;
        if (h === 'updatedAt') th.textContent = 'Mis à jour';
        thead.appendChild(th);
      });

      const editable = new Set(['Leçon','Travaux de classe','Support','Devoirs']);

      filteredData.forEach((row, idx) => {
        const tr = document.createElement('tr');

        displayHeaders.forEach(h => {
          const td = document.createElement('td');
          if (h === '__actions') {
            td.className = 'actions-column';
            const btn = document.createElement('button');
            btn.className = 'save-row-button';
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.addEventListener('click', async () => {
              await saveRow(row, tr);
            });
            td.appendChild(btn);
          } else if (editable.has(h)) {
            td.className = 'editable';
            td.contentEditable = true;
            td.textContent = row[h] ?? '';
            td.addEventListener('input', () => {
              row[h] = td.textContent;
              tr.classList.add('modified');
            });
          } else if (h === 'updatedAt') {
            td.className = 'updated-at-column';
            td.textContent = row.updatedAt ? formatUpdatedAt(row.updatedAt) : '';
          } else {
            td.textContent = row[h] ?? '';
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function formatUpdatedAt(s){
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d.getTime())) return '';
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    async function saveRow(rowData, trEl){
      const btn = trEl.querySelector('.save-row-button');
      setBtnLoading(btn, true, 'fas fa-check');
      try{
        const r = await fetch('/api/save-row', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, data: rowData, section: selectedSection }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur de sauvegarde.');
        trEl.classList.remove('modified');
        const upd = trEl.querySelector('.updated-at-column');
        if (upd && j.updatedData?.updatedAt) upd.textContent = formatUpdatedAt(j.updatedData.updatedAt);
        alertMsg('Ligne enregistrée.', 'success');
      } catch(e){
        alertMsg(`Erreur enregistrement: ${e.message}`, 'error');
      } finally {
        setBtnLoading(btn, false, 'fas fa-check');
      }
    }

    // Enregistrer toutes les lignes affichées
    async function saveAllDisplayedRows(){
      if (!filteredData.length) { alertMsg('Aucune ligne à enregistrer.', 'error'); return; }
      if (!confirm(`Confirmer l'enregistrement de ${filteredData.length} lignes pour la S${currentWeek} ?`)) return;
      setBtnLoading(document.getElementById('saveAllDisplayedBtn'), true, 'fas fa-save');
      let ok=0, err=0;
      for (const row of filteredData){
        try{
          const r = await fetch('/api/save-row', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, data: row, section: selectedSection }) });
          if (!r.ok) throw new Error();
          ok++;
        } catch { err++; }
      }
      alertMsg(err?`Enregistrement terminé: ${ok} succès, ${err} erreurs.`:'Toutes les lignes enregistrées.', err?'warning':'success');
      setBtnLoading(document.getElementById('saveAllDisplayedBtn'), false, 'fas fa-save');
      await loadPlanForWeek();
    }

    // Upload Excel → activer bouton + sauvegarder DB
    function handleFileUpload(e){
      const file = e.target.files[0];
      const status = document.getElementById('file-upload-status');
      const saveBtn = document.getElementById('saveUploadedDataBtn');
      uploadedPlanData = null; saveBtn.disabled = true; status.textContent = '';

      if (!file){ status.textContent = 'Aucun fichier sélectionné.'; return; }
      if (!/\.(xlsx|xls)$/i.test(file.name)){ status.textContent = 'Type invalide (xlsx/xls).'; e.target.value=''; return; }

      status.textContent = `Lecture du fichier ${file.name}...`;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const wb = XLSX.read(ev.target.result, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:null, raw:false });
          const hdr = rows[0].map(h => h ? String(h).trim().replace(/\s+/g,' ') : null).filter(Boolean);
          uploadedPlanData = rows.slice(1).map(r=>{
            const o = {}; hdr.forEach((h,i)=>{ o[h] = r[i] ?? null; });
            return Object.values(o).some(v=>v!=null && String(v).trim()!=='') ? o : null;
          }).filter(Boolean);
          status.textContent = `Fichier ${file.name} lu (${uploadedPlanData.length} lignes).`;
          saveBtn.disabled = !uploadedPlanData.length;
        }catch(err){
          status.textContent = `Erreur lecture: ${err.message}`;
          uploadedPlanData = null; saveBtn.disabled = true; e.target.value='';
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function saveUploadedData(){
      const week = document.getElementById('weekSelector').value;
      if (!week) { alertMsg('Sélectionnez une semaine.', 'error'); return; }
      if (!uploadedPlanData?.length) { alertMsg('Aucune donnée chargée.', 'error'); return; }
      setBtnLoading(document.getElementById('saveUploadedDataBtn'), true, 'fas fa-database');

      try{
        const r = await fetch('/api/save-plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week, data: uploadedPlanData, section: selectedSection }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur serveur.');
        alertMsg(`Données chargées enregistrées pour S${week}.`, 'success');
        if (String(week) === String(currentWeek)) await loadPlanForWeek();
      }catch(e){
        alertMsg(`Erreur d'enregistrement: ${e.message}`, 'error');
      }finally{
        setBtnLoading(document.getElementById('saveUploadedDataBtn'), false, 'fas fa-database');
      }
    }

    // Exports
    async function generateExcelWorkbook(){
      if (!currentWeek) return;
      setBtnLoading(document.getElementById('generateExcelBtn'), true, 'fas fa-file-excel');
      try{
        const r = await fetch('/api/generate-excel-workbook', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, section: selectedSection }) });
        if (!r.ok) throw new Error('Erreur de génération.');
        const blob = await r.blob();
        saveAs(blob, `Plan_Complet_${selectedSection}_S${currentWeek}.xlsx`);
        alertMsg('Fichier Excel généré.', 'success');
      }catch(e){
        alertMsg(e.message, 'error');
      }finally{
        setBtnLoading(document.getElementById('generateExcelBtn'), false, 'fas fa-file-excel');
      }
    }

    async function generateWordByClasse(){
      if (!filteredData.length){ alertMsg('Aucune donnée à exporter.', 'error'); return; }
      setBtnLoading(document.getElementById('generateWordBtn'), true, 'fas fa-file-word');
      const byClass = {};
      filteredData.forEach(r => {
        const c = r['Classe'];
        if (!byClass[c]) byClass[c] = [];
        byClass[c].push(r);
      });
      let ok=0, err=0;
      for (const cls of Object.keys(byClass)){
        try{
          const r = await fetch('/api/generate-word', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, classe: cls, data: byClass[cls], notes: weeklyClassNotes[cls] || '', section: selectedSection }) });
          if (!r.ok) throw new Error(`Erreur pour ${cls}`);
          const blob = await r.blob();
          saveAs(blob, `Plan_${selectedSection}_S${currentWeek}_${cls}.docx`);
          ok++;
        }catch(e){ err++; }
      }
      alertMsg(err?`DOCX: ${ok} succès / ${err} erreurs.`:'DOCX générés.', err?'warning':'success');
      setBtnLoading(document.getElementById('generateWordBtn'), false, 'fas fa-file-word');
    }

    // Notes
    function populateNotesClassSelector(){
      const sel = document.getElementById('notesClassSelector');
      const txt = document.getElementById('notesInput');
      const btn = document.getElementById('saveNotesBtn');
      sel.innerHTML = '<option value="">-- Sélectionnez une classe --</option>';
      const classes = [...new Set(planData.map(r => r['Classe']).filter(Boolean))].sort(compareClasses);
      classes.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      txt.value=''; txt.disabled=true; btn.disabled=true;
    }

    function displayClassNotes(){
      const sel = document.getElementById('notesClassSelector');
      const txt = document.getElementById('notesInput');
      const btn = document.getElementById('saveNotesBtn');
      const c = sel.value;
      if (!c){ txt.value=''; txt.disabled=true; btn.disabled=true; return; }
      txt.value = weeklyClassNotes[c] || '';
      txt.disabled=false; btn.disabled=false;
      document.getElementById('notes-save-status').textContent='';
    }

    async function saveNotes(){
      const c = document.getElementById('notesClassSelector').value;
      if (!c || !currentWeek) return;
      setBtnLoading(document.getElementById('saveNotesBtn'), true, 'fas fa-save');
      try{
        const r = await fetch('/api/save-notes', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, classe: c, notes: document.getElementById('notesInput').value, section: selectedSection }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur sauvegarde.');
        weeklyClassNotes[c] = document.getElementById('notesInput').value;
        alertMsg(`Notes enregistrées pour ${c}, S${currentWeek}.`, 'success');
      }catch(e){
        alertMsg(`Erreur d'enregistrement: ${e.message}`, 'error');
      }finally{
        setBtnLoading(document.getElementById('saveNotesBtn'), false, 'fas fa-save');
      }
    }

    // Admin: classes pour rapport
    async function populateAdminReportClassSelector(){
      const sel = document.getElementById('adminReportClassSelector');
      if (!admins.has(loggedInUser)){ sel.innerHTML='<option value="">(non admin)</option>'; return; }
      sel.innerHTML = '<option value="">-- Chargement des classes --</option>';
      try{
        const r = await fetch(`/api/all-classes?section=${selectedSection}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur serveur');
        sel.innerHTML = '<option value="">-- Sélectionnez une classe pour le rapport --</option>';
        j.sort(compareClasses).forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      }catch(e){
        sel.innerHTML = '<option value="">Erreur chargement</option>';
      }
    }

    async function generateFullReportByClass(){
      const c = document.getElementById('adminReportClassSelector').value;
      if (!c) { alertMsg('Veuillez sélectionner une classe.', 'error'); return; }
      setBtnLoading(document.getElementById('generateFullReportBtn'), true, 'fas fa-file-invoice');
      try{
        const r = await fetch('/api/full-report-by-class', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ classe: c, section: selectedSection }) });
        if (!r.ok) { const j = await r.json(); throw new Error(j.message || 'Erreur'); }
        const blob = await r.blob();
        saveAs(blob, `Rapport_Complet_${selectedSection}_${c}.xlsx`);
        alertMsg(`Rapport complet généré pour ${c}.`, 'success');
      }catch(e){
        alertMsg(e.message, 'error');
      }finally{
        setBtnLoading(document.getElementById('generateFullReportBtn'), false, 'fas fa-file-invoice');
      }
    }

    function updateActionButtonsState(en){
      document.getElementById('generateWordBtn').disabled = !en;
      document.getElementById('generateExcelBtn').disabled = !en;
      document.getElementById('saveAllDisplayedBtn').disabled = !en;
    }

    // —————————— EVENTS ——————————
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-button').addEventListener('click', handleLogin);
      document.getElementById('logout-button').addEventListener('click', handleLogout);
      document.getElementById('togglePassword').addEventListener('click', () => {
        const inp = document.getElementById('password');
        const t = inp.getAttribute('type') === 'password' ? 'text' : 'password';
        inp.setAttribute('type', t);
        document.getElementById('togglePassword').className = t==='password' ? 'fas fa-eye password-toggle-icon' : 'fas fa-eye-slash password-toggle-icon';
      });

      document.getElementById('weekSelector').addEventListener('change', loadPlanForWeek);
      document.getElementById('excelFileInput').addEventListener('change', handleFileUpload);
      document.getElementById('saveUploadedDataBtn').addEventListener('click', saveUploadedData);
      document.getElementById('generateExcelBtn').addEventListener('click', generateExcelWorkbook);
      document.getElementById('generateWordBtn').addEventListener('click', generateWordByClasse);
      document.getElementById('saveAllDisplayedBtn').addEventListener('click', saveAllDisplayedRows);
      document.getElementById('notesClassSelector').addEventListener('change', displayClassNotes);
      document.getElementById('saveNotesBtn').addEventListener('click', saveNotes);

      // auto-remplissage si "remember me"
      const remembered = localStorage.getItem('rememberedUser');
      if (remembered){
        try{
          const { user, section } = JSON.parse(remembered);
          if (user && section){
            document.getElementById('username').value = user;
            document.getElementById('sectionSelectorLogin').value = section;
            document.getElementById('rememberMe').checked = true;
          }
        }catch{}
      }
    });
  </script>
</body>
</html>
