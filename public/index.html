<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans Hebdomadaires</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Scripts pour la manipulation des fichiers Excel et le téléchargement -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body dir="ltr">

    <!-- FORMULAIRE DE CONNEXION -->
    <div id="login-form">
        <img id="logo" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo Al-Kawthar">
        <h1>Connexion</h1>
        <div class="section-selector-container" style="width: 100%; margin-bottom: 15px;">
            <label for="sectionSelectorLogin" style="display: block; margin-bottom: 5px; font-weight: 500;"><i class="fas fa-school"></i> Section :</label>
            <select id="sectionSelectorLogin" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; box-sizing: border-box;">
                <option value="garcons">Garçons</option>
                <option value="filles">Filles</option>
            </select>
        </div>
        <div>
            <label for="username">Nom d'utilisateur (Enseignant) :</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div class="password-container">
            <label for="password">Mot de passe (idem Nom) :</label>
            <input type="password" id="password" name="password" required>
            <i class="fas fa-eye password-toggle-icon" id="togglePassword"></i>
        </div>
        <div class="remember-me-container">
            <input type="checkbox" id="rememberMe" name="rememberMe">
            <label for="rememberMe" id="remember-me-label">Rester connecté</label>
        </div>
        <button id="login-button" class="pro-button"><i class="fas fa-sign-in-alt"></i> <span class="btn-text">Se connecter</span></button>
        <p id="login-error"></p>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <div id="main-content" style="display: none;">
        <div class="main-header-container">
            <img id="logo-main" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo Al-Kawthar">
            <div class="title-user-info">
                 <h1 id="main-title">Plans Hebdomadaires</h1>
                 <h2 id="weekDateRange"></h2>
                 <div class="user-actions-container">
                    <span id="loggedInUserInfo" style="font-style: italic;"></span>
                    <button id="logout-button" class="pro-button danger-button">
                        <i class="fas fa-sign-out-alt"></i> <span class="btn-text">Déconnecter</span>
                    </button>
                 </div>
            </div>
        </div>
        <button id="toggleIncompleteBtn" onclick="toggleIncompleteList()" class="pro-button toggle-incomplete-btn"><i class="fas fa-list-check"></i> <span class="btn-text">Afficher Incomplets</span></button>
        <div id="incompleteTeachersDisplay" style="display: none;">
            <h4>Enseignants Incomplets (Travaux)</h4>
            <ul id="incompleteList"><li>Chargement...</li></ul>
        </div>
        <div class="filter-container week-selector-container">
            <label for="weekSelector"><i class="fas fa-calendar-week"></i> Semaine:</label>
            <select id="weekSelector" onchange="loadPlanForWeek()">
                 <option value="">-- Sélectionnez une semaine --</option>
                 <option value="1">Semaine 1</option><option value="2">Semaine 2</option><option value="3">Semaine 3</option><option value="4">Semaine 4</option><option value="5">Semaine 5</option><option value="6">Semaine 6</option><option value="7">Semaine 7</option><option value="8">Semaine 8</option><option value="9">Semaine 9</option><option value="10">Semaine 10</option><option value="11">Semaine 11</option><option value="12">Semaine 12</option><option value="13">Semaine 13</option><option value="14">Semaine 14</option><option value="15">Semaine 15</option><option value="16">Semaine 16</option><option value="17">Semaine 17</option><option value="18">Semaine 18</option><option value="19">Semaine 19</option><option value="20">Semaine 20</option><option value="21">Semaine 21</option><option value="22">Semaine 22</option><option value="23">Semaine 23</option><option value="24">Semaine 24</option><option value="25">Semaine 25</option><option value="26">Semaine 26</option><option value="27">Semaine 27</option><option value="28">Semaine 28</option><option value="29">Semaine 29</option><option value="30">Semaine 30</option><option value="31">Semaine 31</option><option value="32">Semaine 32</option><option value="33">Semaine 33</option><option value="34">Semaine 34</option><option value="35">Semaine 35</option><option value="36">Semaine 36</option><option value="37">Semaine 37</option><option value="38">Semaine 38</option><option value="39">Semaine 39</option><option value="40">Semaine 40</option><option value="41">Semaine 41</option><option value="42">Semaine 42</option><option value="43">Semaine 43</option><option value="44">Semaine 44</option><option value="45">Semaine 45</option><option value="46">Semaine 46</option><option value="47">Semaine 47</option><option value="48">Semaine 48</option>
            </select>
        </div>
        <div id="admin-actions" class="filter-container admin-section" style="display: none;">
             <h3 id="admin-title">Actions Administrateur</h3>
             <div>
                <label for="excelFileInput" id="admin-excel-label"><i class="fas fa-file-excel"></i> Charger un plan depuis un fichier Excel :</label>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls" onchange="handleFileUpload(event)">
             </div>
             <!-- Ce bouton est activé par JS une fois le fichier lu correctement -->
             <button id="saveUploadedDataBtn" onclick="saveUploadedData()" disabled class="pro-button accent-button"><i class="fas fa-database"></i> <span class="btn-text">Charger et Enregistrer dans la DB</span></button>
             <span id="file-upload-status" style="font-size: 0.9em; font-style: italic; color: var(--muted-text);"></span>
             <div class="admin-subsection">
                <label for="adminReportClassSelector" id="admin-report-class-label"><i class="fas fa-school"></i> Choisir une Classe :</label>
                <select id="adminReportClassSelector"><option value="">-- D'abord charger les classes --</option></select>
                <button id="generateFullReportBtn" onclick="generateFullReportByClass()" class="pro-button success-button"><i class="fas fa-file-invoice"></i> <span class="btn-text">Générer Rapport Complet par Classe</span></button>
             </div>
             <div style="width: 100%; margin-top: 10px; font-size: 0.85em; color: var(--muted-text); border-top: 1px dashed var(--border-color); padding-top: 10px;">
                 <i class="fas fa-info-circle"></i> **Note:** Le fichier Excel doit contenir les en-têtes exacts attendus par le système (ex: Enseignant, Jour, Classe, etc.).
             </div>
        </div>
        <div class="filter-container main-actions-container">
            <button id="generateWordBtn" onclick="generateWordByClasse()" class="action-button pro-button" disabled><i class="fas fa-file-word"></i> <span class="btn-text">Générer Word par Classe</span></button>
            <button id="generateExcelBtn" onclick="generateExcelWorkbook()" class="action-button pro-button" disabled><i class="fas fa-file-excel"></i> <span class="btn-text">Générer Excel (1 Fichier)</span></button>
            <button id="saveAllDisplayedBtn" onclick="saveAllDisplayedRows()" class="action-button save-all-button pro-button" disabled><i class="fas fa-save"></i> <span class="btn-text">Enregistrer Lignes Affichées</span></button>
            <a id="downloadLink" style="display:none;"></a>
        </div>
        <div class="filter-container data-filters-container">
             <label for="filterEnseignant" id="filter-enseignant-label"><i class="fas fa-user-tie"></i> Enseignant:</label>
             <select id="filterEnseignant" onchange="sortAndDisplay()"> <option value="">Tous</option> </select>
             <label for="filterClasse" id="filter-classe-label"><i class="fas fa-chalkboard-user"></i> Classe:</label>
             <select id="filterClasse" onchange="sortAndDisplay()"> <option value="">Toutes</option> </select>
             <label for="filterMatiere" id="filter-matiere-label"><i class="fas fa-book"></i> Matière:</label>
             <select id="filterMatiere" onchange="sortAndDisplay()"> <option value="">Toutes</option> </select>
             <label for="filterPeriode" id="filter-periode-label"><i class="fas fa-clock"></i> Période:</label>
             <select id="filterPeriode" onchange="sortAndDisplay()"> <option value="">Toutes</option> </select>
             <label for="filterJour" id="filter-jour-label"><i class="fas fa-calendar-day"></i> Jour:</label>
             <select id="filterJour" onchange="sortAndDisplay()">
                 <option value="">Tous</option><option value="Dimanche">Dimanche</option><option value="Lundi">Lundi</option><option value="Mardi">Mardi</option><option value="Mercredi">Mercredi</option><option value="Jeudi">Jeudi</option>
            </select>
        </div>
        <div id="message-alerte" style="display: none;"></div>
        <div id="progress-bar-container" style="display: none;"><div id="progress-bar">0%</div></div>
        <div class="notes-container">
            <label for="notesClassSelector" id="notes-class-label" style="font-weight: bold;"><i class="fas fa-sticky-note"></i> Notes pour la classe :</label>
            <select id="notesClassSelector" onchange="displayClassNotes()"><option value="">-- Sélectionnez une classe --</option></select>
            <textarea id="notesInput" rows="4" placeholder="Sélectionnez une classe pour voir ou ajouter des notes..." spellcheck="true" disabled dir="auto"></textarea>
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                <button id="saveNotesBtn" onclick="saveNotes()" class="action-button pro-button success-button" disabled><i class="fas fa-save"></i> <span class="btn-text">Enregistrer Notes</span></button>
                <span id="notes-save-status" style="font-size: 0.9em;"></span>
            </div>
        </div>
        <div class="table-responsive-wrapper">
            <table id="planTable">
                <thead> <tr></tr> </thead>
                <tbody><tr id="initial-table-row"><td colspan="10" style="text-align:center; padding: 20px; color: grey;" id="initial-table-message">Veuillez sélectionner une semaine pour afficher les données.</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Variables Globales ---
        let loggedInUser = null;
        let selectedSection = null;
        let planData = [];
        let filteredAndSortedData = [];
        let uploadedPlanData = null; // Stockera les données JSON lues depuis le fichier Excel
        let headers = [];
        let currentWeek = null;
        let weekStartDate = null;
        let weeklyClassNotes = {};
        let alertTimeoutId = null;

        // --- Configuration des Utilisateurs ---
        const admins = new Set(['Mohamed', 'Zohra']);
        const garconsTeachers = new Set(['Abas', 'Jaber', 'Kamel', 'Majed', 'Mohamed Ali', 'Morched', 'Saeed', 'Sami', 'Sylvano', 'Tonga', 'Youssef', 'Zine']);
        const fillesTeachers = new Set(['Abeer', 'Aichetou', 'Amal', 'Amal Arabic', 'Ange', 'Anouar', 'Emen', 'Farah', 'Fatima Islamic', 'Ghadah', 'Hana - Ameni - PE', 'Nada', 'Raghd ART', 'Salma', 'Sara', 'Souha', 'Takwa', 'Zohra Zidane']);
        
        // --- Fonctions Utilitaires ---
        function displayAlert(msg, isError = false, duration = 5000) {
            const div = document.getElementById('message-alerte');
            div.textContent = msg;
            div.className = isError ? 'alert-error' : 'alert-success';
            div.classList.add('message-alert-base');
            div.style.display = 'block';
            
            clearTimeout(alertTimeoutId);
            alertTimeoutId = setTimeout(() => {
                if (div.textContent === msg) {
                    div.style.display = 'none';
                }
            }, duration);
        }

        function setButtonLoading(btn, isLoading, iconClass) {
            if (!btn) return;
            btn.disabled = isLoading;
            const icon = btn.querySelector('i');
            if (icon) {
                icon.className = isLoading ? 'fas fa-spinner fa-spin' : iconClass;
            }
        }
        
        // --- Fonctions de l'Application (Connexion, etc.) ---
        
        async function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            const rememberMeCheckbox = document.getElementById('rememberMe');
            selectedSection = document.getElementById('sectionSelectorLogin').value;

            errorDiv.textContent = '';
            if (!username || !password) { errorDiv.textContent = "Entrez nom d'utilisateur et mot de passe."; return; }
            setButtonLoading(document.getElementById('login-button'), true, 'fas fa-sign-in-alt');

            try {
                const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || "Échec connexion.");

                if (!admins.has(username)) {
                    if (selectedSection === 'garcons' && !garconsTeachers.has(username)) throw new Error(`Utilisateur non autorisé dans la section Garçons.`);
                    if (selectedSection === 'filles' && !fillesTeachers.has(username)) throw new Error(`Utilisateur non autorisé dans la section Filles.`);
                }
                
                loggedInUser = result.username;
                
                if (rememberMeCheckbox.checked) { localStorage.setItem('rememberedUser', JSON.stringify({ user: loggedInUser, section: selectedSection })); } else { localStorage.removeItem('rememberedUser'); }
                
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('main-title').textContent = `Plans Hebdomadaires - Section ${selectedSection.charAt(0).toUpperCase() + selectedSection.slice(1)}`;
                
                document.getElementById('loggedInUserInfo').textContent = `Connecté: ${loggedInUser}`;
                
                if (admins.has(loggedInUser)) {
                    document.getElementById('admin-actions').style.display = 'flex';
                    // Vous pouvez appeler une fonction pour peupler le sélecteur de classe ici si nécessaire
                    // populateAdminReportClassSelector(); 
                } else {
                    document.getElementById('admin-actions').style.display = 'none';
                }

                displayAlert(`Bienvenue ${loggedInUser} ! Veuillez sélectionner une semaine.`, false);
            } catch (error) {
                errorDiv.textContent = error.message;
            } finally {
                setButtonLoading(document.getElementById('login-button'), false, 'fas fa-sign-in-alt');
            }
        }
        
        function handleLogout() {
            loggedInUser = null; selectedSection = null;
            localStorage.removeItem('rememberedUser');
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').textContent = '';
        }
        
        function togglePasswordVisibility() { const passwordInput = document.getElementById('password'); const toggleIcon = document.getElementById('togglePassword'); const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password'; passwordInput.setAttribute('type', type); toggleIcon.className = (type === 'password') ? 'fas fa-eye password-toggle-icon' : 'fas fa-eye-slash password-toggle-icon'; }

        async function loadPlanForWeek() {
            const week = document.getElementById('weekSelector').value;
            currentWeek = week;
            if (!week) {
                document.getElementById('planTable').querySelector('tbody').innerHTML = `<tr id="initial-table-row"><td colspan="10" style="text-align:center; padding: 20px; color: grey;">Veuillez sélectionner une semaine pour afficher les données.</td></tr>`;
                return;
            }
            displayAlert(`Chargement des données pour la semaine ${week}...`, false);
            try {
                const response = await fetch(`/api/plans/${week}?section=${selectedSection}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Erreur de chargement des données.');
                }
                const result = await response.json();
                planData = result.planData || [];
                // Ici, vous appelleriez votre fonction pour afficher les données dans le tableau
                // displayPlanTable(planData);
                // Pour l'instant, un simple log et une alerte
                console.log("Données chargées :", planData);
                if (planData.length > 0) {
                    displayAlert(`Données de la semaine ${week} chargées avec succès.`, false);
                    // Remplacer le message initial par les données réelles
                    document.getElementById('planTable').querySelector('tbody').innerHTML = `<tr><td colspan="10">Affichage des données ici... (${planData.length} lignes)</td></tr>`;
                } else {
                    document.getElementById('planTable').querySelector('tbody').innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 20px;">Aucune donnée trouvée pour la semaine ${week}.</td></tr>`;
                }
                 // Activer les boutons d'action si des données sont présentes
                const hasData = planData.length > 0;
                document.getElementById('generateWordBtn').disabled = !hasData;
                document.getElementById('generateExcelBtn').disabled = !hasData;
                document.getElementById('saveAllDisplayedBtn').disabled = !hasData;

            } catch (error) {
                displayAlert(error.message, true);
                console.error("Erreur de chargement :", error);
            }
        }

        /**
         * Gère la sélection d'un fichier Excel, le lit et active le bouton de sauvegarde.
         */
         function handleFileUpload(event) {
        const file = event.target.files[0];
        const statusSpan = document.getElementById('file-upload-status');
        const saveBtn = document.getElementById('saveUploadedDataBtn');
        uploadedPlanData = null; saveBtn.disabled = true; statusSpan.textContent = '';
        if (!file) { statusSpan.textContent = "Aucun fichier sélectionné."; return; }
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) { displayAlert("Type de fichier invalide (.xlsx ou .xls requis).", true); statusSpan.textContent = "Type invalide."; event.target.value = ''; return; }
        statusSpan.textContent = `Lecture du fichier ${file.name}...`;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
                uploadedPlanData = jsonData.filter(row => Object.values(row).some(cell => cell !== null && String(cell).trim() !== ''));
                if (uploadedPlanData.length > 0) {
                    statusSpan.textContent = `Fichier lu: ${uploadedPlanData.length} lignes prêtes.`;
                    saveBtn.disabled = false;
                    displayAlert(`Fichier lu. Cliquez sur "Charger et Enregistrer" pour sauvegarder.`, false);
                } else {
                    statusSpan.textContent = "Le fichier semble vide.";
                    displayAlert("Aucune donnée trouvée dans le fichier.", true);
                }
            } catch (error) { displayAlert(`Erreur lecture fichier: ${error.message}`, true); statusSpan.textContent = 'Erreur de lecture.'; uploadedPlanData = null; saveBtn.disabled = true; event.target.value = ''; }
        };
        reader.readAsArrayBuffer(file);
    }

    async function saveUploadedData() {
        const selectedWeek = document.getElementById('weekSelector').value;
        if (!selectedWeek) { displayAlert("Veuillez d'abord sélectionner une semaine.", true); return; }
        if (!uploadedPlanData || uploadedPlanData.length === 0) { displayAlert("Aucune donnée à enregistrer.", true); return; }
        const saveBtn = document.getElementById('saveUploadedDataBtn');
        setButtonLoading(saveBtn, true, 'fas fa-database');
        try {
            const response = await fetch('/api/save-plan', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ week: selectedWeek, data: uploadedPlanData, section: selectedSection }) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            displayAlert(result.message, false);
            document.getElementById('excelFileInput').value = '';
            statusSpan.textContent = '';
            uploadedPlanData = null;
            saveBtn.disabled = true;
            if (selectedWeek === currentWeek) await loadPlanForWeek();
        } catch (error) {
            displayAlert(`Erreur: ${error.message}`, true);
        } finally {
            setButtonLoading(saveBtn, false, 'fas fa-database');
        }
    }
    
    // --- Fonctions de Génération de Documents ---
    async function generateWordByClasse() {
        if (!filteredAndSortedData.length) { displayAlert('Aucune donnée affichée à exporter.', true); return; }
        setButtonLoading(document.getElementById('generateWordBtn'), true, 'fas fa-file-word');
        const dataByClass = {};
        const classKey = findHKey('Classe');
        if (!classKey) { displayAlert("Colonne 'Classe' introuvable.", true); return; }
        filteredAndSortedData.forEach(item => { const className = item[classKey]; if (!dataByClass[className]) dataByClass[className] = []; dataByClass[className].push(item); });
        
        for (const className in dataByClass) {
            try {
                const payload = { week: currentWeek, classe: className, data: dataByClass[className], notes: weeklyClassNotes[className] || '', section: selectedSection };
                const response = await fetch('/api/generate-word', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Erreur pour la classe ${className}`);
                const blob = await response.blob();
                saveAs(blob, `Plan_${selectedSection}_S${currentWeek}_${className}.docx`);
            } catch (e) { displayAlert(`Erreur génération Word pour ${className}: ${e.message}`, true); }
        }
        setButtonLoading(document.getElementById('generateWordBtn'), false, 'fas fa-file-word');
    }

    async function generateExcelWorkbook() {
        if (!currentWeek) return;
        setButtonLoading(document.getElementById('generateExcelBtn'), true, 'fas fa-file-excel');
        try {
            const response = await fetch('/api/generate-excel-workbook', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ week: currentWeek, section: selectedSection }) });
            if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
            const blob = await response.blob();
            saveAs(blob, `Plan_Complet_${selectedSection}_S${currentWeek}.xlsx`);
        } catch (e) { displayAlert(`Erreur génération Excel: ${e.message}`, true); }
        finally { setButtonLoading(document.getElementById('generateExcelBtn'), false, 'fas fa-file-excel'); }
    }
    
    async function populateAdminReportClassSelector() {
        const select = document.getElementById('adminReportClassSelector');
        select.innerHTML = `<option value="">Chargement...</option>`;
        select.disabled = true;
        try {
            const response = await fetch(`/api/all-classes?section=${selectedSection}`);
            if (!response.ok) throw new Error(`Erreur serveur`);
            const classes = await response.json();
            if (classes && classes.length > 0) {
                select.innerHTML = `<option value="">-- Sélectionnez une classe --</option>`;
                classes.sort(compareClasses).forEach(cls => { const opt = document.createElement('option'); opt.value = cls; opt.textContent = cls; select.appendChild(opt); });
                select.disabled = false;
            } else { select.innerHTML = `<option value="">-- Aucune classe trouvée --</option>`; }
        } catch (error) { select.innerHTML = `<option value="">Erreur chargement</option>`; }
    }

    async function generateFullReportByClass() {
        const selectedClass = document.getElementById('adminReportClassSelector').value;
        if (!selectedClass) { displayAlert('Veuillez sélectionner une classe.', true); return; }
        setButtonLoading(document.getElementById('generateFullReportBtn'), true, 'fas fa-file-invoice');
        try {
            const response = await fetch('/api/full-report-by-class', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ classe: selectedClass, section: selectedSection }) });
            if (response.ok) {
                const blob = await response.blob();
                saveAs(blob, `Rapport_Complet_${selectedSection}_${selectedClass}.xlsx`);
            } else { const err = await response.json(); throw new Error(err.message); }
        } catch (error) { displayAlert(`Erreur: ${error.message}`, true); }
        finally { setButtonLoading(document.getElementById('generateFullReportBtn'), false, 'fas fa-file-invoice'); }
    }

    // --- Fonctions de Notes ---
    function populateNotesClassSelector() {
        const sel = document.getElementById('notesClassSelector');
        sel.innerHTML = `<option value="">-- Sélectionnez une classe --</option>`;
        const clsK = findHKey('Classe');
        if (!clsK || !planData || planData.length === 0) return;
        const uniqueCls = [...new Set(planData.map(i => i[clsK]).filter(Boolean))].sort(compareClasses);
        uniqueCls.forEach(cls => { const opt = document.createElement('option'); opt.value = cls; opt.textContent = cls; sel.appendChild(opt); });
    }

    function displayClassNotes() {
        const sel = document.getElementById('notesClassSelector');
        const txt = document.getElementById('notesInput');
        const btn = document.getElementById('saveNotesBtn');
        const selCls = sel.value;
        if (selCls) {
            txt.value = weeklyClassNotes[selCls] || '';
            txt.disabled = false;
            btn.disabled = false;
        } else {
            txt.value = '';
            txt.disabled = true;
            btn.disabled = true;
        }
    }

    async function saveNotes() {
        const selCls = document.getElementById('notesClassSelector').value;
        if (!selCls || !currentWeek) return;
        setButtonLoading(document.getElementById('saveNotesBtn'), true, 'fas fa-save');
        try {
            const response = await fetch('/api/save-notes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ week: currentWeek, classe: selCls, notes: document.getElementById('notesInput').value, section: selectedSection }) });
            if (!response.ok) { const err = await response.json(); throw new Error(err.message); }
            weeklyClassNotes[selCls] = document.getElementById('notesInput').value;
            displayAlert(`Notes pour ${selCls} enregistrées.`, false);
        } catch (error) { displayAlert(`Erreur: ${error.message}`, true); }
        finally { setButtonLoading(document.getElementById('saveNotesBtn'), false, 'fas fa-save'); }
    }
    
    // --- Écouteurs d'événements ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('togglePassword').addEventListener('click', togglePasswordVisibility);
        
        const remembered = localStorage.getItem('rememberedUser');
        if (remembered) {
            try {
                const { user, section } = JSON.parse(remembered);
                if (user && section) {
                    document.getElementById('username').value = user;
                    document.getElementById('password').value = user; // Simplification, vous pourriez vouloir ne pas sauvegarder le mot de passe
                    document.getElementById('sectionSelectorLogin').value = section;
                    document.getElementById('rememberMe').checked = true;
                }
            } catch (e) { localStorage.removeItem('rememberedUser'); }
        }
    });

</script>
