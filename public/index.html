<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plans Hebdomadaires</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-form">
    <img id="logo" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo">
    <h1>Connexion</h1>

    <div class="section-selector-container">
      <label for="sectionSelectorLogin"><i class="fas fa-school"></i> Section :</label>
      <select id="sectionSelectorLogin">
        <option value="garcons">Garçons</option>
        <option value="filles">Filles</option>
      </select>
    </div>

    <div>
      <label for="username">Nom d'utilisateur (Enseignant) :</label>
      <input id="username" type="text" />
    </div>

    <div class="password-container">
      <label for="password">Mot de passe (idem Nom) :</label>
      <input id="password" type="password" />
      <i class="fas fa-eye password-toggle-icon" id="togglePassword"></i>
    </div>

    <div class="remember-me-container">
      <input id="rememberMe" type="checkbox" />
      <label for="rememberMe">Rester connecté</label>
    </div>

    <button id="login-button" class="pro-button"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
    <p id="login-error"></p>
  </div>

  <!-- MAIN -->
  <div id="main-content" style="display:none;">
    <div class="main-header-container">
      <img id="logo-main" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo">
      <div class="title-user-info">
        <h1 id="main-title">Plans Hebdomadaires</h1>
        <h2 id="weekDateRange"></h2>
        <div class="user-actions-container">
          <span id="loggedInUserInfo" style="font-style:italic;"></span>
          <button id="logout-button" class="pro-button danger-button"><i class="fas fa-sign-out-alt"></i> Déconnecter</button>
        </div>
      </div>
    </div>

    <div class="filter-container week-selector-container">
      <label for="weekSelector"><i class="fas fa-calendar-week"></i> Semaine :</label>
      <select id="weekSelector"></select>
    </div>

    <!-- BARRE DE TRI -->
    <div class="filter-container">
      <label><i class="fas fa-arrow-down-a-z"></i> Tri :</label>
      <select id="sortKey">
        <option value="Classe">Classe</option>
        <option value="Enseignant">Enseignant</option>
        <option value="Matière">Matière</option>
        <option value="Jour">Jour</option>
        <option value="Période">Période</option>
        <option value="updatedAt">Mis à jour</option>
      </select>
      <select id="sortOrder">
        <option value="asc">Ascendant</option>
        <option value="desc">Descendant</option>
      </select>
      <button id="applySortBtn" class="pro-button"><i class="fas fa-sort"></i> Appliquer</button>
      <button id="resetSortBtn" class="pro-button"><i class="fas fa-rotate-right"></i> Réinitialiser</button>
    </div>

    <div id="admin-actions" class="filter-container admin-section" style="display:none;">
      <h3>Actions Administrateur</h3>
      <div>
        <label for="excelFileInput"><i class="fas fa-file-excel"></i> Fichier Excel :</label>
        <input id="excelFileInput" type="file" accept=".xlsx,.xls" />
      </div>
      <button id="saveUploadedDataBtn" class="pro-button accent-button" disabled>
        <i class="fas fa-database"></i> Charger et Enregistrer dans la DB
      </button>
      <span id="file-upload-status" style="font-size:.9em;"></span>

      <div class="admin-subsection">
        <label for="adminReportClassSelector"><i class="fas fa-school"></i> Choisir une Classe :</label>
        <select id="adminReportClassSelector"><option value="">-- D'abord charger les classes --</option></select>
        <button id="generateFullReportBtn" class="pro-button success-button">
          <i class="fas fa-file-invoice"></i> Générer Rapport Complet par Classe
        </button>
      </div>
    </div>

    <div class="filter-container main-actions-container">
      <button id="generateWordBtn" class="pro-button" disabled><i class="fas fa-file-word"></i> Générer Word par Classe</button>
      <button id="generateExcelBtn" class="pro-button" disabled><i class="fas fa-file-excel"></i> Générer Excel (1 Fichier)</button>
      <button id="saveAllDisplayedBtn" class="pro-button" disabled><i class="fas fa-save"></i> Enregistrer Lignes Affichées</button>
    </div>

    <div id="message-alerte" style="display:none;"></div>
    <div id="progress-bar-container" style="display:none;"><div id="progress-bar">0%</div></div>

    <div class="notes-container">
      <label for="notesClassSelector" style="font-weight:bold;"><i class="fas fa-sticky-note"></i> Notes pour la classe :</label>
      <select id="notesClassSelector"><option value="">-- Sélectionnez une classe --</option></select>
      <textarea id="notesInput" rows="4" placeholder="Sélectionnez une classe..." disabled></textarea>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:5px;">
        <button id="saveNotesBtn" class="pro-button success-button" disabled><i class="fas fa-save"></i> Enregistrer Notes</button>
        <span id="notes-save-status" style="font-size:.9em;"></span>
      </div>
    </div>

    <div class="table-responsive-wrapper">
      <table id="planTable">
        <thead><tr></tr></thead>
        <tbody><tr id="initial-table-row"><td id="initial-table-message" colspan="12" style="text-align:center;padding:20px;color:#777">Veuillez sélectionner une semaine pour afficher les données.</td></tr></tbody>
      </table>
    </div>
  </div>

  <script>
    // —————————— GLOBALS ——————————
    let loggedInUser = null;
    let selectedSection = null;
    let planData = [];
    let filteredData = [];
    let headers = [];
    let currentWeek = null;
    let weeklyClassNotes = {};
    let uploadedPlanData = null;

    const admins = new Set(['Mohamed','Zohra']);

    const weeks = Array.from({length:48}, (_,i)=>i+1);
    const classOrder = ['PEI1','PEI2','PEI3','PEI4','PEI5','DP1','DP2'];
    const findH = (target) => headers.find(h => h.trim().toLowerCase() === String(target).toLowerCase());
    function compareClasses(a,b){
      const ia = classOrder.indexOf(a), ib = classOrder.indexOf(b);
      if (ia!==-1 && ib!==-1) return ia-ib;
      return String(a||'').localeCompare(String(b||''));
    }
    function setBtnLoading(btn, loading, icon) {
      if (!btn) return;
      btn.disabled = loading;
      const i = btn.querySelector('i');
      if (i) i.className = loading ? 'fas fa-spinner fa-spin' : icon;
    }
    function alertMsg(text, type='success') {
      const div = document.getElementById('message-alerte');
      div.className = `message-alert-base alert-${type}`;
      div.textContent = text;
      div.style.display = 'block';
      setTimeout(()=>{ div.style.display='none'; }, type==='error'?8000:5000);
    }
    function formatUpdatedAt(s){
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d.getTime())) return '';
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    // —————————— LOGIN ——————————
    async function handleLogin(){
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const err = document.getElementById('login-error');
      const remember = document.getElementById('rememberMe').checked;
      selectedSection = document.getElementById('sectionSelectorLogin').value;

      err.textContent = '';
      if (!username || !password) { err.textContent = "Entrez nom d'utilisateur et mot de passe."; return; }
      setBtnLoading(document.getElementById('login-button'), true, 'fas fa-sign-in-alt');
      try {
        const r = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
        const okJson = await r.json();
        if (!r.ok || !okJson.success) throw new Error(okJson.message || 'Échec connexion.');

        // restriction section côté front (admins passent partout)
        if (!admins.has(username)) {
          const g = new Set(['Abas','Jaber','Kamel','Majed','Mohamed Ali','Morched','Saeed','Sami','Sylvano','Tonga','Youssef','Zine']);
          const f = new Set(['Abeer','Aichetou','Amal','Amal Arabic','Ange','Anouar','Emen','Farah','Fatima Islamic','Ghadah','Hana - Ameni - PE','Nada','Raghd ART','Salma','Sara','Souha','Takwa','Zohra Zidane']);
          if (selectedSection==='garcons' && !g.has(username)) throw new Error('Utilisateur non autorisé (Garçons).');
          if (selectedSection==='filles' && !f.has(username)) throw new Error('Utilisateur non autorisé (Filles).');
        }

        loggedInUser = okJson.username;
        if (remember) localStorage.setItem('rememberedUser', JSON.stringify({ user: loggedInUser, section: selectedSection }));
        else localStorage.removeItem('rememberedUser');

        document.getElementById('login-form').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('loggedInUserInfo').textContent = `Connecté: ${loggedInUser}`;
        document.getElementById('main-title').textContent = `Plans Hebdomadaires - ${selectedSection[0].toUpperCase()+selectedSection.slice(1)}`;

        const weekSel = document.getElementById('weekSelector');
        weekSel.innerHTML = '<option value="">-- Sélectionnez une semaine --</option>';
        weeks.forEach(w => {
          const opt = document.createElement('option'); opt.value = w; opt.textContent = `Semaine ${w}`; weekSel.appendChild(opt);
        });

        document.getElementById('admin-actions').style.display = admins.has(loggedInUser) ? 'flex' : 'none';
        alertMsg(`Bienvenue ${loggedInUser}!`, 'success');
      } catch (e) {
        err.textContent = e.message;
      } finally {
        setBtnLoading(document.getElementById('login-button'), false, 'fas fa-sign-in-alt');
      }
    }

    function handleLogout(){
      loggedInUser = null; selectedSection = null;
      localStorage.removeItem('rememberedUser');
      document.getElementById('main-content').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('username').value=''; document.getElementById('password').value='';
      document.getElementById('login-error').textContent='';
    }

    // —————————— DATA FLOW ——————————
    async function loadPlanForWeek() {
      const week = document.getElementById('weekSelector').value;
      if (!week) { resetMain(); return; }
      currentWeek = week;

      try {
        const r = await fetch(`/api/plans/${week}?section=${selectedSection}`);
        const data = await r.json();
        if (!r.ok) throw new Error(data.message || 'Erreur serveur.');

        planData = Array.isArray(data.planData) ? data.planData : [];
        weeklyClassNotes = data.classNotes || {};
        headers = planData.length ? Object.keys(planData[0]).filter(h => h !== '_id' && h !== 'id') : [];
        if (!headers.length) headers = ['Enseignant','Jour','Période','Classe','Matière','Leçon','Travaux de classe','Support','Devoirs','updatedAt'];

        filteredData = planData.slice();
        renderTable();
        populateNotesClassSelector();
        updateActionButtonsState(planData.length>0);
        populateAdminReportClassSelector();
      } catch (e) {
        alertMsg(`Erreur chargement S${week}: ${e.message}`, 'error');
        resetMain();
      }
    }

    function resetMain(){
      planData = []; filteredData = []; headers = []; weeklyClassNotes = {};
      document.querySelector('#planTable thead tr').innerHTML = '';
      document.querySelector('#planTable tbody').innerHTML =
        '<tr><td colspan="12" style="text-align:center;padding:20px;color:#777">Veuillez sélectionner une semaine pour afficher les données.</td></tr>';
      document.getElementById('generateWordBtn').disabled = true;
      document.getElementById('generateExcelBtn').disabled = true;
      document.getElementById('saveAllDisplayedBtn').disabled = true;
      document.getElementById('notesClassSelector').innerHTML = '<option value="">-- Sélectionnez une classe --</option>';
      document.getElementById('notesInput').value = ''; document.getElementById('notesInput').disabled = true;
      document.getElementById('saveNotesBtn').disabled = true;
      document.getElementById('excelFileInput').value = '';
      document.getElementById('saveUploadedDataBtn').disabled = true;
      document.getElementById('file-upload-status').textContent = '';
      document.getElementById('weekDateRange').textContent = '';
    }

    // ——————— TRI ———————
    function applySort(){
      const key = document.getElementById('sortKey').value;
      const order = document.getElementById('sortOrder').value;
      const dir = order === 'desc' ? -1 : 1;

      filteredData.sort((a,b) => {
        const va = (a[key] ?? '').toString().trim();
        const vb = (b[key] ?? '').toString().trim();
        if (key === 'Classe') return dir * compareClasses(va, vb);
        if (key === 'Période') return dir * ((parseInt(va,10)||0) - (parseInt(vb,10)||0));
        if (key === 'updatedAt') return dir * (new Date(va) - new Date(vb));
        return dir * va.localeCompare(vb, 'fr', { numeric:true, sensitivity:'base' });
      });
      renderTable(); // réafficher
    }
    function resetSort(){
      filteredData = planData.slice();
      renderTable();
    }

    // —————————— RENDU TABLEAU ——————————
    function renderTable(){
      const thead = document.querySelector('#planTable thead tr');
      const tbody = document.querySelector('#planTable tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';

      const displayHeaders = [...new Set([
        'Enseignant','Jour','Période','Classe','Matière','Leçon','Travaux de classe','Support','Devoirs','updatedAt','__actions'
      ])];

      displayHeaders.forEach(h => {
        const th = document.createElement('th');
        th.textContent = (h === '__actions') ? 'Actions' : (h === 'updatedAt' ? 'Mis à jour' : h);
        thead.appendChild(th);
      });

      const editable = new Set(['Leçon','Travaux de classe','Support','Devoirs']);

      filteredData.forEach((row) => {
        const tr = document.createElement('tr');

        displayHeaders.forEach(h => {
          const td = document.createElement('td');

          if (h === '__actions') {
            td.className = 'actions-column';
            // bouton SAVE
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-row-button';
            saveBtn.title = 'Enregistrer cette ligne';
            saveBtn.innerHTML = '<i class="fas fa-check"></i>';
            saveBtn.addEventListener('click', async () => { await saveRow(row, tr); });

            // bouton IA
            const aiBtn = document.createElement('button');
            aiBtn.className = 'save-row-button';
            aiBtn.title = 'Proposer un plan de leçon (IA)';
            aiBtn.style.color = '#0d6efd';
            aiBtn.style.marginLeft = '8px';
            aiBtn.innerHTML = '<i class="fas fa-robot"></i>';
            aiBtn.addEventListener('click', async () => { await askAIForRow(row, tr, aiBtn); });

            td.appendChild(saveBtn);
            td.appendChild(aiBtn);
          } else if (editable.has(h)) {
            td.className = 'editable';
            td.contentEditable = true;
            td.textContent = row[h] ?? '';
            td.addEventListener('input', () => {
              row[h] = td.textContent;
              tr.classList.add('modified');
            });
          } else if (h === 'updatedAt') {
            td.className = 'updated-at-column';
            td.textContent = row.updatedAt ? formatUpdatedAt(row.updatedAt) : '';
          } else {
            td.textContent = row[h] ?? '';
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // activer / désactiver actions globales
      updateActionButtonsState(filteredData.length>0);
    }

    async function saveRow(rowData, trEl){
      const btn = trEl.querySelector('.save-row-button'); // le premier (✓)
      setBtnLoading(btn, true, 'fas fa-check');
      try{
        const r = await fetch('/api/save-row', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, data: rowData, section: selectedSection }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur de sauvegarde.');
        trEl.classList.remove('modified');
        const upd = trEl.querySelector('.updated-at-column');
        if (upd && j.updatedData?.updatedAt) upd.textContent = formatUpdatedAt(j.updatedData.updatedAt);
        alertMsg('Ligne enregistrée.', 'success');
      } catch(e){
        alertMsg(`Erreur enregistrement: ${e.message}`, 'error');
      } finally {
        setBtnLoading(btn, false, 'fas fa-check');
      }
    }

    // —————————— IA PAR LIGNE ——————————
    async function askAIForRow(row, trEl, aiBtn){
      setBtnLoading(aiBtn, true, 'fas fa-robot');
      try {
        const r = await fetch('/api/generate-ai-lesson-plan', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ row, locale: 'fr' })
        });
        const j = await r.json();
        if (!r.ok || !j.ok) throw new Error(j.message || 'Échec IA.');

        // injecter les champs proposés
        const s = j.suggestion || {};
        ['Leçon','Travaux de classe','Support','Devoirs'].forEach(k => {
          if (s[k]) row[k] = s[k];
        });

        // rafraîchir la rangée (simplement ré-écrire les cellules)
        const cells = trEl.querySelectorAll('td');
        const mapIndex = {
          'Leçon': displayIndex('Leçon'),
          'Travaux de classe': displayIndex('Travaux de classe'),
          'Support': displayIndex('Support'),
          'Devoirs': displayIndex('Devoirs')
        };
        Object.entries(mapIndex).forEach(([k, idx]) => {
          if (idx !== -1 && cells[idx]) {
            cells[idx].textContent = row[k] || '';
          }
        });

        trEl.classList.add('modified');
        alertMsg('Suggestion IA appliquée. Cliquez sur ✓ pour enregistrer.', 'success');
      } catch (e) {
        alertMsg(e.message, 'error');
      } finally {
        setBtnLoading(aiBtn, false, 'fas fa-robot');
      }

      function displayIndex(key){
        const order = ['Enseignant','Jour','Période','Classe','Matière','Leçon','Travaux de classe','Support','Devoirs','updatedAt','__actions'];
        return order.indexOf(key);
      }
    }

    // Enregistrer toutes les lignes affichées
    async function saveAllDisplayedRows(){
      if (!filteredData.length) { alertMsg('Aucune ligne à enregistrer.', 'error'); return; }
      if (!confirm(`Confirmer l'enregistrement de ${filteredData.length} lignes pour la S${currentWeek} ?`)) return;
      setBtnLoading(document.getElementById('saveAllDisplayedBtn'), true, 'fas fa-save');
      let ok=0, err=0;
      for (const row of filteredData){
        try{
          const r = await fetch('/api/save-row', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, data: row, section: selectedSection }) });
          if (!r.ok) throw new Error();
          ok++;
        } catch { err++; }
      }
      alertMsg(err?`Enregistrement terminé: ${ok} succès, ${err} erreurs.`:'Toutes les lignes enregistrées.', err?'warning':'success');
      setBtnLoading(document.getElementById('saveAllDisplayedBtn'), false, 'fas fa-save');
      await loadPlanForWeek();
    }

    // Upload Excel
    function handleFileUpload(e){
      const file = e.target.files[0];
      const status = document.getElementById('file-upload-status');
      const saveBtn = document.getElementById('saveUploadedDataBtn');
      uploadedPlanData = null; saveBtn.disabled = true; status.textContent = '';

      if (!file){ status.textContent = 'Aucun fichier sélectionné.'; return; }
      if (!/\.(xlsx|xls)$/i.test(file.name)){ status.textContent = 'Type invalide (xlsx/xls).'; e.target.value=''; return; }

      status.textContent = `Lecture du fichier ${file.name}...`;
      const reader = new FileReader();
      reader.onload = function(ev){
        try{
          const wb = XLSX.read(ev.target.result, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:null, raw:false });
          const hdr = rows[0].map(h => h ? String(h).trim().replace(/\s+/g,' ') : null).filter(Boolean);
          uploadedPlanData = rows.slice(1).map(r=>{
            const o = {}; hdr.forEach((h,i)=>{ o[h] = r[i] ?? null; });
            return Object.values(o).some(v=>v!=null && String(v).trim()!=='') ? o : null;
          }).filter(Boolean);
          status.textContent = `Fichier ${file.name} lu (${uploadedPlanData.length} lignes).`;
          saveBtn.disabled = !uploadedPlanData.length;
        }catch(err){
          status.textContent = `Erreur lecture: ${err.message}`;
          uploadedPlanData = null; saveBtn.disabled = true; e.target.value='';
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function saveUploadedData(){
      const week = document.getElementById('weekSelector').value;
      if (!week) { alertMsg('Sélectionnez une semaine.', 'error'); return; }
      if (!uploadedPlanData?.length) { alertMsg('Aucune donnée chargée.', 'error'); return; }
      setBtnLoading(document.getElementById('saveUploadedDataBtn'), true, 'fas fa-database');

      try{
        const r = await fetch('/api/save-plan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week, data: uploadedPlanData, section: selectedSection }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur serveur.');
        alertMsg(`Données chargées enregistrées pour S${week}.`, 'success');
        if (String(week) === String(currentWeek)) await loadPlanForWeek();
      }catch(e){
        alertMsg(`Erreur d'enregistrement: ${e.message}`, 'error');
      }finally{
        setBtnLoading(document.getElementById('saveUploadedDataBtn'), false, 'fas fa-database');
      }
    }

    // Exports
    async function generateExcelWorkbook(){
      if (!currentWeek) return;
      setBtnLoading(document.getElementById('generateExcelBtn'), true, 'fas fa-file-excel');
      try{
        const r = await fetch('/api/generate-excel-workbook', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, section: selectedSection }) });
        if (!r.ok) throw new Error('Erreur de génération.');
        const blob = await r.blob();
        saveAs(blob, `Plan_Complet_${selectedSection}_S${currentWeek}.xlsx`);
        alertMsg('Fichier Excel généré.', 'success');
      }catch(e){
        alertMsg(e.message, 'error');
      }finally{
        setBtnLoading(document.getElementById('generateExcelBtn'), false, 'fas fa-file-excel');
      }
    }

    async function generateWordByClasse(){
      if (!filteredData.length){ alertMsg('Aucune donnée à exporter.', 'error'); return; }
      setBtnLoading(document.getElementById('generateWordBtn'), true, 'fas fa-file-word');
      const byClass = {};
      filteredData.forEach(r => {
        const c = r['Classe'];
        if (!byClass[c]) byClass[c] = [];
        byClass[c].push(r);
      });
      let ok=0, err=0;
      for (const cls of Object.keys(byClass)){
        try{
          const r = await fetch('/api/generate-word', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ week: currentWeek, classe: cls, data: byClass[cls], notes: weeklyClassNotes[cls] || '', section: selectedSection }) });
          if (!r.ok) throw new Error(`Erreur pour ${cls}`);
          const blob = await r.blob();
          saveAs(blob, `Plan_${selectedSection}_S${currentWeek}_${cls}.docx`);
          ok++;
        }catch(e){ err++; }
      }
      alertMsg(err?`DOCX: ${ok} succès / ${err} erreurs.`:'DOCX générés.', err?'warning':'success');
      setBtnLoading(document.getElementById('generateWordBtn'), false, 'fas fa-file-word');
    }

    // Notes
    function populateNotesClassSelector(){
      const sel = document.getElementById('notesClassSelector');
      const txt = document.getElementById('notesInput');
      const btn = document.getElementById('saveNotesBtn');
      sel.innerHTML = '<option value="">-- Sélectionnez une classe --</option>';
      const classes = [...new Set(planData.map(r => r['Classe']).filter(Boolean))].sort(compareClasses);
      classes.forEach(c => { const o = document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      txt.value=''; txt.disabled=true; btn.disabled=true;
    }
    function displayClassNotes(){
      const sel = document.getElementById('notesClassSelector');
      const txt = document.getElementById('notesInput');
      const btn = document.getElementById('saveNotesBtn');
      const c = sel.value;
      if (!c){ txt.value=''; txt.disabled=true; btn.disabled=true; return; }
      txt.value = weeklyClassNotes[c] || '';
      txt.disabled=false; btn.disabled=false;
      document.getElementById('notes-save-status').textContent='';
    }

    // Admin: classes pour rapport
    async function populateAdminReportClassSelector(){
      const sel = document.getElementById('adminReportClassSelector');
      if (!admins.has(loggedInUser)){ sel.innerHTML='<option value="">(non admin)</option>'; return; }
      sel.innerHTML = '<option value="">-- Chargement des classes --</option>';
      try{
        const r = await fetch(`/api/all-classes?section=${selectedSection}`);
        const j = await r.json();
        if (!r.ok) throw new Error(j.message || 'Erreur serveur');
        sel.innerHTML = '<option value="">-- Sélectionnez une classe pour le rapport --</option>';
        j.sort(compareClasses).forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      }catch(e){
        sel.innerHTML = '<option value="">Erreur chargement</option>';
      }
    }

    function updateActionButtonsState(en){
      document.getElementById('generateWordBtn').disabled = !en;
      document.getElementById('generateExcelBtn').disabled = !en;
      document.getElementById('saveAllDisplayedBtn').disabled = !en;
    }

    // —————————— EVENTS ——————————
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-button').addEventListener('click', handleLogin);
      document.getElementById('logout-button').addEventListener('click', handleLogout);
      document.getElementById('togglePassword').addEventListener('click', () => {
        const inp = document.getElementById('password');
        const t = inp.getAttribute('type') === 'password' ? 'text' : 'password';
        inp.setAttribute('type', t);
        document.getElementById('togglePassword').className = t==='password' ? 'fas fa-eye password-toggle-icon' : 'fas fa-eye-slash password-toggle-icon';
      });

      document.getElementById('weekSelector').addEventListener('change', loadPlanForWeek);
      document.getElementById('excelFileInput').addEventListener('change', handleFileUpload);
      document.getElementById('saveUploadedDataBtn').addEventListener('click', saveUploadedData);
      document.getElementById('generateExcelBtn').addEventListener('click', generateExcelWorkbook);
      document.getElementById('generateWordBtn').addEventListener('click', generateWordByClasse);
      document.getElementById('saveAllDisplayedBtn').addEventListener('click', saveAllDisplayedRows);
      document.getElementById('notesClassSelector').addEventListener('change', displayClassNotes);
      document.getElementById('saveNotesBtn').addEventListener('click', saveNotes);

      document.getElementById('applySortBtn').addEventListener('click', applySort);
      document.getElementById('resetSortBtn').addEventListener('click', resetSort);

      const remembered = localStorage.getItem('rememberedUser');
      if (remembered){
        try{
          const { user, section } = JSON.parse(remembered);
          if (user && section){
            document.getElementById('username').value = user;
            document.getElementById('sectionSelectorLogin').value = section;
            document.getElementById('rememberMe').checked = true;
          }
        }catch{}
      }
    });
  </script>
</body>
</html>
