<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans Hebdomadaires</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body dir="ltr">

    <!-- ======================== -->
    <!-- FORMULAIRE DE CONNEXION  -->
    <!-- ======================== -->
    <div id="login-form">
        <img id="logo" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo Al-Kawthar">
        <h1 id="login-title">Connexion</h1>
        
        <div class="section-selector-container" style="width:100%; margin-bottom:15px;">
            <label for="sectionSelectorLogin"><i class="fas fa-school"></i> Section :</label>
            <select id="sectionSelectorLogin" style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:5px;">
                <option value="garcons">Garçons</option>
                <option value="filles">Filles</option>
            </select>
        </div>

        <div>
            <label for="username" id="login-username-label">Nom d'utilisateur (Enseignant) :</label>
            <input type="text" id="username" required>
        </div>
        <div class="password-container">
            <label for="password" id="login-password-label">Mot de passe (idem Nom) :</label>
            <input type="password" id="password" required>
            <i class="fas fa-eye password-toggle-icon" id="togglePassword"></i>
        </div>
        <div class="remember-me-container">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe" id="remember-me-label">Rester connecté</label>
        </div>
        <button id="login-button" class="pro-button"><i class="fas fa-sign-in-alt"></i> <span class="btn-text">Se connecter</span></button>
        <p id="login-error"></p>
    </div>

    <!-- ======================== -->
    <!-- CONTENU PRINCIPAL        -->
    <!-- ======================== -->
    <div id="main-content" style="display: none;">

        <div class="main-header-container">
            <img id="logo-main" src="https://cdn.glitch.global/1c613b14-019c-488a-a856-d55d64d174d0/al-kawthar-international-schools-jeddah-saudi-arabia-modified.png?v=1739565146299" alt="Logo">
            <div class="title-user-info">
                <h1 id="main-title">Plans Hebdomadaires</h1>
                <h2 id="weekDateRange"></h2>
                <div class="user-actions-container">
                    <span id="loggedInUserInfo" style="font-style:italic;"></span>
                    <button id="logout-button" class="pro-button danger-button">
                        <i class="fas fa-sign-out-alt"></i> <span class="btn-text">Déconnecter</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="filter-container week-selector-container">
            <label for="weekSelector" id="week-label"><i class="fas fa-calendar-week"></i> Semaine:</label>
            <select id="weekSelector" onchange="loadPlanForWeek()"></select>
        </div>

        <div id="message-alerte" style="display: none;"></div>
        <div id="progress-bar-container" style="display: none;"><div id="progress-bar">0%</div></div>
        
        <!-- Conteneur générique pour les sections, le JS affichera le bon -->
        <div id="section-content-wrapper">
            <!-- Le contenu de la section Garçons ou Filles sera injecté ici par le JS -->
        </div>

    </div>

    <!-- ======================== -->
    <!-- TEMPLATES POUR SECTIONS  -->
    <!-- ======================== -->
    <template id="section-template">
        <div class="section-container">
            <h2 class="section-title"></h2>
            
            <div class="admin-actions-placeholder"></div>

            <div class="filter-container main-actions-container">
                <button class="action-button pro-button generateWordBtn" disabled><i class="fas fa-file-word"></i> <span class="btn-text">Générer Word par Classe</span></button>
                <button class="action-button pro-button generateExcelBtn" disabled><i class="fas fa-file-excel"></i> <span class="btn-text">Générer Excel (1 Fichier)</span></button>
                <button class="action-button pro-button saveAllDisplayedBtn" disabled><i class="fas fa-save"></i> <span class="btn-text">Enregistrer Lignes Affichées</span></button>
            </div>
            
            <div class="filter-container data-filters-container">
                <label class="filter-enseignant-label"><i class="fas fa-user-tie"></i> Enseignant:</label> <select class="filterEnseignant"> <option value=""></option> </select>
                <label class="filter-classe-label"><i class="fas fa-chalkboard-user"></i> Classe:</label> <select class="filterClasse"> <option value=""></option> </select>
                <label class="filter-matiere-label"><i class="fas fa-book"></i> Matière:</label> <select class="filterMatiere"> <option value=""></option> </select>
                <label class="filter-periode-label"><i class="fas fa-clock"></i> Période:</label> <select class="filterPeriode"> <option value=""></option> </select>
                <label class="filter-jour-label"><i class="fas fa-calendar-day"></i> Jour:</label> 
                <select class="filterJour">
                    <option value=""></option>
                    <option value="Dimanche">Dimanche</option><option value="Lundi">Lundi</option><option value="Mardi">Mardi</option><option value="Mercredi">Mercredi</option><option value="Jeudi">Jeudi</option>
                </select>
            </div>
             <div class="notes-container">
                <label class="notes-class-label"><i class="fas fa-sticky-note"></i> Notes pour la classe :</label> 
                <select class="notesClassSelector"><option value=""></option></select>
                <textarea class="notesInput" rows="4" spellcheck="true" disabled></textarea>
                <button class="action-button pro-button success-button saveNotesBtn" disabled><i class="fas fa-save"></i> <span class="btn-text">Enregistrer Notes</span></button>
            </div>
            <div class="table-responsive-wrapper">
                <table class="planTable"><thead><tr></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </template>
    
    <script>
    // ====== GLOBALS ======
    let loggedInUser = null;
    let selectedSection = null; // 'garcons' ou 'filles'
    let isAdmin = false;
    let currentWeek = null;
    let currentUserLanguage = 'fr';

    const sectionData = {
        garcons: { planData: [], filteredData: [], headers: [], weeklyClassNotes: {} },
        filles:  { planData: [], filteredData: [], headers: [], weeklyClassNotes: {} }
    };
    
    // ====== USERS & PERMISSIONS ======
    const admins = new Set(['Mohamed', 'Zohra']);
    const teachers_garcons = new Set(['Abas','Jaber','Kamel','Majed','Mohamed Ali','Morched','Saeed','Sami','Sylvano','Tonga','Youssef','Zine']);
    const teachers_filles = new Set(['Abeer','Aichetou','Amal','Amal Arabic','Ange','Anouar','Emen','Farah','Fatima Islamic','Ghadah','Hana - Ameni - PE','Nada','Raghd ART','Salma','Sara','Souha','Takwa','Zohra Zidane']);
    
    // NOUVEAU: Mappage des utilisateurs par langue
    const arabicUsers = new Set(['Jaber', 'Majed', 'Saeed', 'Fatima Islamic', 'Amal Arabic', 'Emen', 'Ghadah', 'Raghd', 'Sara']);
    const englishUsers = new Set(['Amal', 'Kamel', 'Abeer', 'Salma']);

    // ====== CONFIG & CONSTANTS ======
    const weekDates = {
      1:{start:'2025-08-31',end:'2025-09-04'},2:{start:'2025-09-07',end:'2025-09-11'},3:{start:'2025-09-14',end:'2025-09-18'},
      4:{start:'2025-09-21',end:'2025-09-25'},5:{start:'2025-09-28',end:'2025-10-02'},6:{start:'2025-10-05',end:'2025-10-09'},
      7:{start:'2025-10-12',end:'2025-10-16'},8:{start:'2025-10-19',end:'2025-10-23'},9:{start:'2025-10-26',end:'2025-10-30'},
      10:{start:'2025-11-02',end:'2025-11-06'},11:{start:'2025-11-09',end:'2025-11-13'},12:{start:'2025-11-16',end:'2025-11-20'},
      13:{start:'2025-11-23',end:'2025-11-27'},14:{start:'2025-11-30',end:'2025-12-04'},15:{start:'2025-12-07',end:'2025-12-11'},
      16:{start:'2025-12-14',end:'2025-12-18'},17:{start:'2025-12-21',end:'2025-12-25'},18:{start:'2025-12-28',end:'2026-01-01'},
      19:{start:'2026-01-04',end:'2026-01-08'},20:{start:'2026-01-11',end:'2026-01-15'},21:{start:'2026-01-18',end:'2026-01-22'},
      22:{start:'2026-01-25',end:'2026-01-29'},23:{start:'2026-02-01',end:'2026-02-05'},24:{start:'2026-02-08',end:'2026-02-12'},
      25:{start:'2026-02-15',end:'2026-02-19'},26:{start:'2026-02-22',end:'2026-02-26'},27:{start:'2026-03-01',end:'2026-03-05'},
      28:{start:'2026-03-08',end:'2026-03-12'},29:{start:'2026-03-15',end:'2026-03-19'},30:{start:'2026-03-22',end:'2026-03-26'},
      31:{start:'2026-03-29',end:'2026-04-02'},32:{start:'2026-04-05',end:'2026-04-09'},33:{start:'2026-04-12',end:'2026-04-16'},
      34:{start:'2026-04-19',end:'2026-04-23'},35:{start:'2026-04-26',end:'2026-04-30'},36:{start:'2026-05-03',end:'2026-05-07'},
      37:{start:'2026-05-10',end:'2026-05-14'},38:{start:'2026-05-17',end:'2026-05-21'},39:{start:'2026-05-24',end:'2026-05-28'},
      40:{start:'2026-05-31',end:'2026-06-04'},41:{start:'2026-06-07',end:'2026-06-11'},42:{start:'2026-06-14',end:'2026-06-18'},
      43:{start:'2026-06-21',end:'2026-06-25'},44:{start:'2026-06-28',end:'2026-07-02'},45:{start:'2026-07-05',end:'2026-07-09'},
      46:{start:'2026-07-12',end:'2026-07-16'},47:{start:'2026-07-19',end:'2026-07-23'},48:{start:'2026-07-26',end:'2026-07-30'}
    };
    const classOrder = ['PEI1','PEI2','PEI3','PEI4','PEI5','DP1','DP2'];
    
    // ====== TRANSLATIONS (Réintégré du code original) ======
    const translations = {
        fr: { 
            login_title: "Connexion", login_username_label: "Nom d'utilisateur (Enseignant) :", login_password_label: "Mot de passe (idem Nom) :", login_button_text: "Se connecter", remember_me: "Rester connecté", logout_button: "Déconnecter", main_page_title: "Plans Hebdomadaires",
            week_label: "Semaine:", select_week: "-- Sélectionnez une semaine --", welcome_user: "Bienvenue {user} !", connected_as: "Connecté: {user}",
            generate_word_button: "Générer Word par Classe", generate_excel_button: "Générer Excel (1 Fichier)", save_all_button: "Enregistrer Lignes Affichées",
            filter_teacher_label: "Enseignant:", filter_class_label: "Classe:", filter_material_label: "Matière:", filter_period_label: "Période:", filter_day_label: "Jour:",
            all: "Tous", all_f: "Toutes", day_sun: "Dimanche", day_mon: "Lundi", day_tue: "Mardi", day_wed: "Mercredi", day_thu: "Jeudi",
            notes_for_class: "Notes pour la classe :", select_class: "-- Sélectionnez une classe --", save_notes_button: "Enregistrer Notes",
            headers: { 'Enseignant': 'Enseignant', 'Jour': 'Jour', 'Période': 'Période', 'Classe': 'Classe', 'Matière': 'Matière', 'Leçon': 'Leçon', 'Travaux de classe': 'Travaux de classe', 'Support': 'Support', 'Devoirs': 'Devoirs', 'actions': "Actions", 'updated_at': "Mis à jour" }
        },
        ar: { 
            login_title: "تسجيل الدخول", login_username_label: "اسم المستخدم (المعلم):", login_password_label: "كلمة المرور (نفس الاسم):", login_button_text: "تسجيل الدخول", remember_me: "تذكرني", logout_button: "تسجيل الخروج", main_page_title: "الخطط الأسبوعية",
            week_label: "الأسبوع:", select_week: "-- اختر أسبوع --", welcome_user: "مرحباً {user}!", connected_as: "متصل: {user}",
            generate_word_button: "إنشاء ملف وورد حسب الفصل", generate_excel_button: "إنشاء ملف اكسل (ملف واحد)", save_all_button: "حفظ الصفوف المعروضة",
            filter_teacher_label: "المعلم:", filter_class_label: "الفصل:", filter_material_label: "المادة:", filter_period_label: "الحصة:", filter_day_label: "اليوم:",
            all: "الكل", all_f: "الكل", day_sun: "الأحد", day_mon: "الاثنين", day_tue: "الثلاثاء", day_wed: "الأربعاء", day_thu: "الخميس",
            notes_for_class: "ملاحظات للفصل:", select_class: "-- اختر فصل --", save_notes_button: "حفظ الملاحظات",
            headers: { 'Enseignant': 'المعلم', 'Jour': 'اليوم', 'Période': 'الحصة', 'Classe': 'الفصل', 'Matière': 'المادة', 'Leçon': 'الدرس', 'Travaux de classe': 'أعمال الفصل', 'Support': 'الدعم', 'Devoirs': 'الواجبات', 'actions': "إجراءات", 'updated_at': "آخر تحديث" }
        },
        en: { 
            login_title: "Login", login_username_label: "Username (Teacher):", login_password_label: "Password (same as Name):", login_button_text: "Login", remember_me: "Remember me", logout_button: "Logout", main_page_title: "Weekly Plans",
            week_label: "Week:", select_week: "-- Select a week --", welcome_user: "Welcome {user}!", connected_as: "Connected: {user}",
            generate_word_button: "Generate Word by Class", generate_excel_button: "Generate Excel (1 File)", save_all_button: "Save Displayed Rows",
            filter_teacher_label: "Teacher:", filter_class_label: "Class:", filter_material_label: "Subject:", filter_period_label: "Period:", filter_day_label: "Day:",
            all: "All", all_f: "All", day_sun: "Sunday", day_mon: "Monday", day_tue: "Tuesday", day_wed: "Wednesday", day_thu: "Thursday",
            notes_for_class: "Notes for class:", select_class: "-- Select a class --", save_notes_button: "Save Notes",
            headers: { 'Enseignant': 'Teacher', 'Jour': 'Day', 'Période': 'Period', 'Classe': 'Class', 'Matière': 'Subject', 'Leçon': 'Lesson', 'Travaux de classe': 'Classwork', 'Support': 'Support', 'Devoirs': 'Homework', 'actions': "Actions", 'updated_at': "Updated At" }
        }
    };
    const t = (key, params = {}) => { let text = translations[currentUserLanguage]?.[key] || translations.fr[key] || key; for (const p in params) { text = text.replace(`{${p}}`, params[p]); } return text; };

    // ====== UTILS ======
    function compareClasses(a, b) { const ia=classOrder.indexOf(a), ib=classOrder.indexOf(b); if(ia!==-1&&ib!==-1) return ia-ib; return String(a||'').localeCompare(String(b||'')); }
    function setBtnLoading(btn, loading, iconClass) { if(!btn) return; btn.disabled = loading; const i = btn.querySelector('i'); if(i) i.className = loading ? 'fas fa-spinner fa-spin' : iconClass; }
    function alertMsg(msgKey, type='success', params={}) { const msg = t(msgKey, params); const div=document.getElementById('message-alerte'); div.className=`message-alert-base alert-${type}`; div.textContent=msg; div.style.display='block'; setTimeout(() => { div.style.display='none'; }, type==='error' ? 8000 : 5000); }
    function formatUpdatedAt(s) { if(!s) return ''; const d=new Date(s); if(isNaN(d.getTime())) return''; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    const findH = (k) => sectionData[selectedSection]?.headers.find(h => h.trim().toLowerCase() === String(k).toLowerCase());

    // ====== LOGIN / LOGOUT ======
    async function handleLogin() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const section = document.getElementById('sectionSelectorLogin').value;
        const errDiv = document.getElementById('login-error');
        errDiv.textContent = '';

        if (!username || !password) { errDiv.textContent = "Entrez nom d'utilisateur et mot de passe."; return; }

        setBtnLoading(document.getElementById('login-button'), true, 'fas fa-sign-in-alt');
        try {
            const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.message || 'Échec connexion.');

            loggedInUser = result.username;
            selectedSection = section;
            isAdmin = admins.has(loggedInUser);
            
            if (!isAdmin) {
                if (selectedSection === 'garcons' && !teachers_garcons.has(loggedInUser)) throw new Error('Utilisateur non autorisé pour la section Garçons.');
                if (selectedSection === 'filles' && !teachers_filles.has(loggedInUser)) throw new Error('Utilisateur non autorisée pour la section Filles.');
            }
            
            // DÉFINIR LA LANGUE
            if (arabicUsers.has(loggedInUser)) currentUserLanguage = 'ar';
            else if (englishUsers.has(loggedInUser)) currentUserLanguage = 'en';
            else currentUserLanguage = 'fr';
            
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            setupSectionUI(selectedSection); // Crée l'UI pour la section
            applyLanguageSettings(); // Applique la traduction
            
            const weekSelector = document.getElementById('weekSelector');
            weekSelector.innerHTML = `<option value="">${t('select_week')}</option>`;
            for (let i = 1; i <= 48; i++) {
                const option = document.createElement('option'); option.value = i; option.textContent = `${t('week_label').replace(':', '')} ${i}`; weekSelector.appendChild(option);
            }
            
            alertMsg('welcome_user', 'success', {user: loggedInUser});

        } catch (e) {
            errDiv.textContent = e.message;
        } finally {
            setBtnLoading(document.getElementById('login-button'), false, 'fas fa-sign-in-alt');
        }
    }

    function handleLogout() {
        //...
        window.location.reload(); // La façon la plus simple de tout réinitialiser
    }
    
    // ====== DATA & UI SETUP ======
    function setupSectionUI(section) {
        const wrapper = document.getElementById('section-content-wrapper');
        const template = document.getElementById('section-template');
        wrapper.innerHTML = ''; // Nettoyer
        const clone = template.content.cloneNode(true);
        wrapper.appendChild(clone);
        
        // Attacher les événements aux nouveaux éléments clonés
        const sectionRoot = wrapper.querySelector('.section-container');
        sectionRoot.querySelector('.generateWordBtn').addEventListener('click', generateWordByClasse);
        sectionRoot.querySelector('.generateExcelBtn').addEventListener('click', generateExcelWorkbook);
        sectionRoot.querySelector('.saveAllDisplayedBtn').addEventListener('click', saveAllDisplayedRows);
        sectionRoot.querySelector('.saveNotesBtn').addEventListener('click', saveNotes);
        sectionRoot.querySelector('.notesClassSelector').addEventListener('change', displayClassNotes);

        sectionRoot.querySelectorAll('.data-filters-container select').forEach(sel => {
            sel.addEventListener('change', sortAndDisplay);
        });
    }

    async function loadPlanForWeek() {
        const week = document.getElementById('weekSelector').value;
        currentWeek = week;
        if (!week) { /* ... reset logic ... */ return; }

        try {
            const response = await fetch(`/api/plans/${week}?section=${selectedSection}`);
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erreur serveur.');

            let rawData = Array.isArray(result.planData) ? result.planData : [];
            
            // NOUVEAU: Filtrer les données pour les enseignants non-admins
            if (!isAdmin) {
                const teacherKey = rawData.length ? Object.keys(rawData[0]).find(k => k.trim().toLowerCase() === 'enseignant') : null;
                if (teacherKey) {
                    rawData = rawData.filter(row => row[teacherKey] === loggedInUser);
                }
            }
            
            sectionData[selectedSection].planData = rawData;
            sectionData[selectedSection].weeklyClassNotes = result.classNotes || {};
            sectionData[selectedSection].headers = rawData.length ? Object.keys(rawData[0]).filter(k => k !== '_id' && k !== 'id') : [];
            
            populateFilterOptions();
            sortAndDisplay();
            populateNotesClassSelector();
            updateActionButtonsState(true);

        } catch (e) {
            alertMsg('error', 'error', {error: `Erreur chargement S${week}: ${e.message}`});
        }
    }

    function sortAndDisplay() {
        const section = selectedSection;
        const wrapper = document.getElementById('section-content-wrapper');
        const data = sectionData[section].planData;

        const ensF = wrapper.querySelector('.filterEnseignant').value;
        const clsF = wrapper.querySelector('.filterClasse').value;
        const matF = wrapper.querySelector('.filterMatiere').value;
        const perF = wrapper.querySelector('.filterPeriode').value;
        const jF = wrapper.querySelector('.filterJour').value;

        const ensK = findH('Enseignant'), clsK = findH('Classe'), matK = findH('Matière'), perK = findH('Période'), jK = findH('Jour');

        let filtered = data.filter(item => {
            const passEns = !ensF || (ensK && item[ensK] === ensF);
            const passCls = !clsF || (clsK && item[clsK] === clsF);
            const passMat = !matF || (matK && item[matK] === matF);
            const passPer = !perF || (perK && String(item[perK]) === perF);
            const passJour = !jF || (jK && item[jK] === jF);
            return passEns && passCls && passMat && passPer && passJour;
        });

        const dayOrder = { "Dimanche": 1, "Lundi": 2, "Mardi": 3, "Mercredi": 4, "Jeudi": 5 };
        filtered.sort((a, b) => {
            const classComp = clsK ? compareClasses(a[clsK], b[clsK]) : 0;
            if (classComp !== 0) return classComp;
            const dayComp = jK ? (dayOrder[a[jK]] || 99) - (dayOrder[b[jK]] || 99) : 0;
            if (dayComp !== 0) return dayComp;
            return perK ? (parseInt(a[perK], 10) || 0) - (parseInt(b[perK], 10) || 0) : 0;
        });

        sectionData[section].filteredData = filtered;
        renderTable();
    }
    
    function renderTable() {
        const section = selectedSection;
        const wrapper = document.getElementById('section-content-wrapper');
        const thead = wrapper.querySelector('.planTable thead tr');
        const tbody = wrapper.querySelector('.planTable tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';
        
        const data = sectionData[section].filteredData;
        if (!sectionData[section].headers.length) return;

        const headersToDisplay = ['Enseignant', 'Jour', 'Période', 'Classe', 'Matière', 'Leçon', 'Travaux de classe', 'Support', 'Devoirs'];
        const headerTranslations = t('headers');
        
        headersToDisplay.forEach(h => { if(findH(h)){ const th = document.createElement('th'); th.textContent = headerTranslations[h] || h; thead.appendChild(th); }});
        const thActions = document.createElement('th'); thActions.textContent = headerTranslations['actions']; thead.appendChild(thActions);
        const thUpdated = document.createElement('th'); thUpdated.textContent = headerTranslations['updated_at']; thead.appendChild(thUpdated);
        
        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${thead.children.length}" style="text-align:center;">Aucune donnée.</td></tr>`;
            return;
        }
        
        const editableKeys = new Set(['Leçon', 'Travaux de classe', 'Support', 'Devoirs']);

        data.forEach((rowData, rowIndex) => {
            const tr = document.createElement('tr');
            headersToDisplay.forEach(header => {
                const key = findH(header);
                if (!key) return;
                const td = document.createElement('td');
                td.textContent = rowData[key] ?? '';
                td.dir = 'auto';
                if (editableKeys.has(header)) {
                    td.contentEditable = true;
                    td.classList.add('editable');
                    td.addEventListener('input', (e) => { rowData[key] = e.target.textContent; tr.classList.add('modified'); });
                }
                tr.appendChild(td);
            });
            
            const tdActions = document.createElement('td');
            const saveBtn = document.createElement('button');
            saveBtn.innerHTML = '<i class="fas fa-check"></i>'; saveBtn.className = 'save-row-button';
            saveBtn.onclick = () => saveRow(rowData, tr);
            tdActions.appendChild(saveBtn);
            tr.appendChild(tdActions);

            const tdUpdated = document.createElement('td');
            tdUpdated.textContent = formatUpdatedAt(rowData[findH('updatedAt')]);
            tr.appendChild(tdUpdated);

            tbody.appendChild(tr);
        });
    }

    // ====== ACTIONS (SAVE, GENERATE...) ======
    async function saveRow(rowData, tr) {
        const btn = tr.querySelector('.save-row-button');
        setBtnLoading(btn, true, 'fas fa-check');
        try {
            const response = await fetch('/api/save-row', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ week: currentWeek, data: rowData, section: selectedSection })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Erreur.');
            
            tr.classList.remove('modified');
            const updKey = findH('updatedAt');
            if (updKey && result.updatedData?.updatedAt) {
                rowData[updKey] = result.updatedData.updatedAt;
                tr.cells[tr.cells.length - 1].textContent = formatUpdatedAt(result.updatedData.updatedAt);
            }
        } catch (e) {
            alertMsg('error', 'error', {error: e.message});
        } finally {
            setBtnLoading(btn, false, 'fas fa-check');
        }
    }
    // Les fonctions generateWord, generateExcel, saveNotes, etc. sont à adapter de manière similaire,
    // en utilisant `document.querySelector` pour cibler les éléments dans la section active.
    async function generateWordByClasse() { /* ... */ }
    async function generateExcelWorkbook() { /* ... */ }
    async function saveAllDisplayedRows() { /* ... */ }
    async function saveNotes() { /* ... */ }
    function displayClassNotes() { /* ... */ }


    // ====== HELPERS & UI UPDATES ======
    function populateFilterOptions() {
        const section = selectedSection;
        const wrapper = document.getElementById('section-content-wrapper');
        const data = sectionData[section].planData;
        const getUniq = (k) => k ? [...new Set(data.map(i => i[k]).filter(Boolean))].sort() : [];
        
        const updateSel = (selector, key, defaultTextKey, isClass=false) => {
            const sel = wrapper.querySelector(selector);
            sel.innerHTML = `<option value="">${t(defaultTextKey)}</option>`;
            const options = getUniq(key);
            if(isClass) options.sort(compareClasses);
            options.forEach(o => { const opt = document.createElement('option'); opt.value = o; opt.textContent = o; sel.appendChild(opt); });
        };
        
        updateSel('.filterEnseignant', findH('Enseignant'), 'all');
        updateSel('.filterClasse', findH('Classe'), 'all_f', true);
        updateSel('.filterMatiere', findH('Matière'), 'all_f');
        updateSel('.filterPeriode', findH('Période'), 'all_f');

        if (!isAdmin) {
             const ensSelect = wrapper.querySelector('.filterEnseignant');
             ensSelect.value = loggedInUser;
             ensSelect.disabled = true;
        }
    }
    
    function populateNotesClassSelector() {
         const section = selectedSection;
         const wrapper = document.getElementById('section-content-wrapper');
         const sel = wrapper.querySelector('.notesClassSelector');
         const clsKey = findH('Classe');
         if(!clsKey) return;
         const classes = [...new Set(sectionData[section].planData.map(r => r[clsKey]).filter(Boolean))].sort(compareClasses);
         sel.innerHTML = `<option value="">${t('select_class')}</option>`;
         classes.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
    }

    function updateActionButtonsState(enabled) {
        if (!selectedSection) return;
        const wrapper = document.getElementById('section-content-wrapper');
        wrapper.querySelectorAll('.action-button').forEach(btn => btn.disabled = !enabled);
    }
    
    // ====== LANGUAGE FUNCTIONS ======
    function applyLanguageSettings() {
        document.documentElement.lang = currentUserLanguage;
        document.body.dir = (currentUserLanguage === 'ar') ? 'rtl' : 'ltr';
        updateStaticUIElements();
        // Dynamic elements will be updated as data is loaded/rendered
    }
    
    function updateStaticUIElements() {
        // Login Page
        document.getElementById('login-title').textContent = t('login_title');
        document.getElementById('login-username-label').textContent = t('login_username_label');
        document.getElementById('login-password-label').textContent = t('login_password_label');
        document.querySelector('#login-button .btn-text').textContent = t('login_button_text');
        document.getElementById('remember-me-label').textContent = t('remember_me');

        // Main Page
        if (loggedInUser) {
            document.title = t('main_page_title');
            document.getElementById('main-title').textContent = t('main_page_title');
            document.querySelector('#logout-button .btn-text').textContent = t('logout_button');
            document.getElementById('loggedInUserInfo').textContent = t('connected_as', {user: loggedInUser});
            document.getElementById('week-label').innerHTML = `<i class="fas fa-calendar-week"></i> ${t('week_label')}`;
            
            const wrapper = document.getElementById('section-content-wrapper');
            if(wrapper.innerHTML === '') return;

            const sectionTitle = selectedSection === 'garcons' ? 'Section Garçons' : 'Section Filles'; // ou traduire
            wrapper.querySelector('.section-title').textContent = sectionTitle;

            wrapper.querySelector('.generateWordBtn .btn-text').textContent = t('generate_word_button');
            wrapper.querySelector('.generateExcelBtn .btn-text').textContent = t('generate_excel_button');
            wrapper.querySelector('.saveAllDisplayedBtn .btn-text').textContent = t('save_all_button');
            wrapper.querySelector('.saveNotesBtn .btn-text').textContent = t('save_notes_button');
            
            wrapper.querySelector('.filter-enseignant-label').innerHTML = `<i class="fas fa-user-tie"></i> ${t('filter_teacher_label')}`;
            wrapper.querySelector('.filter-classe-label').innerHTML = `<i class="fas fa-chalkboard-user"></i> ${t('filter_class_label')}`;
            wrapper.querySelector('.filter-matiere-label').innerHTML = `<i class="fas fa-book"></i> ${t('filter_material_label')}`;
            wrapper.querySelector('.filter-periode-label').innerHTML = `<i class="fas fa-clock"></i> ${t('filter_period_label')}`;
            wrapper.querySelector('.filter-jour-label').innerHTML = `<i class="fas fa-calendar-day"></i> ${t('filter_day_label')}`;
            wrapper.querySelector('.notes-class-label').innerHTML = `<i class="fas fa-sticky-note"></i> ${t('notes_for_class')}`;

            // Mettre à jour les options des selects de jours
            const daySelect = wrapper.querySelector('.filterJour');
            daySelect.querySelector('option[value=""]').textContent = t('all');
            daySelect.querySelector('option[value="Dimanche"]').textContent = t('day_sun');
            daySelect.querySelector('option[value="Lundi"]').textContent = t('day_mon');
            // ... etc pour les autres jours
        }
    }


    // ====== EVENTS ======
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('togglePassword').addEventListener('click', () => {
             const p = document.getElementById('password'); 
             p.type = p.type === 'password' ? 'text' : 'password';
        });
        applyLanguageSettings(); // Met à jour la page de login en français au chargement
    });

    </script>
</body>
</html>
